<nav class="navbar">
    <div class="nav-container">
        <div class="nav-brand">
            <i class="fas fa-table-tennis-paddle-ball"></i>
            <a href="{% url 'home' %}">Paddle Booking</a>
        </div>

        <div class="nav-menu">
            <a href="{% url 'news' %}" class="nav-item {% if request.path == '/news/' %}active{% endif %}">Новости</a>
            <a href="{% url 'booking' %}" class="nav-item {% if request.path == '/booking/' %}active{% endif %}">Бронирование</a>
            <a href="{% url 'coaches_list' %}" class="nav-item {% if '/users/coaches/' in request.path %}active{% endif %}">Тренеры</a>
            <a href="{% url 'tournaments' %}" class="nav-item {% if request.path == '/tournaments/' %}active{% endif %}">Турниры</a>
        </div>

        <div class="nav-auth">
            <!-- Переключатель темной темы -->
            <button class="theme-toggle" onclick="toggleTheme()" title="Переключить тему">
                <i class="fas fa-moon"></i>
            </button>

            {% if user.is_authenticated %}
                <div class="user-dropdown">
                    <button class="user-btn">
                        <i class="fas fa-user"></i>
                        {{ user.username }}
                    </button>
                    <div class="dropdown-content">
                        <a href="{% url 'profile' %}" id="profile-link"><i class="fas fa-user"></i> Профиль</a>
                        <a href="{% url 'profile' %}#bookings" id="bookings-link"><i class="fas fa-calendar"></i> Мои записи</a>
                        <a href="{% url 'profile' %}#statistics" id="statistics-link"><i class="fas fa-chart-bar"></i> Моя статистика</a>
                        <a href="{% url 'training_sessions' %}"><i class="fas fa-dumbbell"></i> Мои тренировки</a>
                        <a href="{% url 'profile' %}#rating" id="rating-link"><i class="fas fa-chart-line"></i> Мой рейтинг</a>
                        <a href="#" id="openLogoutModal"><i class="fas fa-sign-out-alt"></i> Выйти</a>
                    </div>
                </div>
            {% else %}
                <!-- Изменено: вместо ссылок на страницы - кнопки для модальных окон -->
                <button class="auth-btn login-btn" id="openLoginModal">Войти</button>
                <button class="auth-btn register-btn" id="openRegisterModal">Зарегистрироваться</button>
            {% endif %}
        </div>
    </div>
</nav>

<!-- Модальное окно выхода -->
<div id="logoutModal" class="modal">
    <div class="modal-content">
        <span class="close-modal">&times;</span>
        <div class="logout-confirmation">
            <i class="fas fa-sign-out-alt"></i>
            <h2>Выйти из аккаунта</h2>
            <p>Вы уверены, что хотите выйти из своего аккаунта?</p>
            <div class="logout-buttons">
                <button type="button" class="btn-secondary" id="cancelLogout">Отмена</button>
                <button type="button" class="btn-danger" id="confirmLogout">Выйти</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Обработчики для навигации по профилю
    const profileLink = document.getElementById('profile-link');
    const bookingsLink = document.getElementById('bookings-link');
    const ratingLink = document.getElementById('rating-link');

    // При клике на "Профиль" - просто переходим на страницу профиля
    // (по умолчанию откроется первая вкладка "Данные профиля")
    if (profileLink) {
        profileLink.addEventListener('click', function(e) {
            // Можно добавить хеш #profile для явного указания, но это не обязательно
            // window.location.href = "{% url 'profile' %}#profile";
        });
    }

    // При клике на "Мои записи" - добавляем хеш #bookings к URL
    if (bookingsLink) {
        bookingsLink.addEventListener('click', function(e) {
            e.preventDefault(); // Предотвращаем стандартный переход
            window.location.href = "{% url 'profile' %}#bookings";
        });
    }

    // При клике на "Мой рейтинг" - добавляем хеш #rating к URL
    if (ratingLink) {
        ratingLink.addEventListener('click', function(e) {
            e.preventDefault(); // Предотвращаем стандартный переход
            window.location.href = "{% url 'profile' %}#rating";
        });
    }

    // ========== УПРАВЛЕНИЕ ВЫПАДАЮЩИМ МЕНЮ ПОЛЬЗОВАТЕЛЯ ==========
    const userDropdown = document.querySelector('.user-dropdown');
    const userBtn = document.querySelector('.user-btn');
    const dropdownContent = document.querySelector('.dropdown-content');

    if (userBtn && dropdownContent) {
        // Создаем backdrop для мобильных устройств
        const backdrop = document.createElement('div');
        backdrop.className = 'dropdown-backdrop';
        document.body.appendChild(backdrop);

        // Переключение меню по клику на кнопку
        userBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            const isOpen = dropdownContent.classList.contains('show');

            if (isOpen) {
                closeDropdown();
            } else {
                openDropdown();
            }
        });

        // Функция открытия меню
        function openDropdown() {
            dropdownContent.classList.add('show');
            userBtn.classList.add('active');
            backdrop.classList.add('show');

            // Предотвращаем скролл на мобильных когда меню открыто
            if (window.innerWidth <= 768) {
                document.body.style.overflow = 'hidden';
            }
        }

        // Функция закрытия меню
        function closeDropdown() {
            dropdownContent.classList.remove('show');
            userBtn.classList.remove('active');
            backdrop.classList.remove('show');
            document.body.style.overflow = '';
        }

        // Закрытие при клике вне меню
        document.addEventListener('click', function(e) {
            if (!userDropdown.contains(e.target)) {
                closeDropdown();
            }
        });

        // Закрытие при клике на backdrop
        backdrop.addEventListener('click', closeDropdown);

        // Закрытие при нажатии Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && dropdownContent.classList.contains('show')) {
                closeDropdown();
            }
        });

        // Закрытие меню при клике на любую ссылку внутри
        dropdownContent.querySelectorAll('a').forEach(link => {
            link.addEventListener('click', function() {
                closeDropdown();
            });
        });
    }

    // ========== УПРАВЛЕНИЕ МОДАЛЬНЫМИ ОКНАМИ ==========

    // Получаем элементы модальных окон
    const logoutModal = document.getElementById('logoutModal');
    const openLogoutModalBtn = document.getElementById('openLogoutModal');
    const closeModalBtns = document.querySelectorAll('.close-modal');
    const cancelLogoutBtn = document.getElementById('cancelLogout');
    const confirmLogoutBtn = document.getElementById('confirmLogout');

    // Открытие модального окна выхода
    if (openLogoutModalBtn) {
        openLogoutModalBtn.addEventListener('click', function() {
            if (logoutModal) {
                logoutModal.style.display = 'flex';
            }
        });
    }

    // Закрытие модальных окон при клике на крестик
    closeModalBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            this.closest('.modal').style.display = 'none';
        });
    });

    // Закрытие модальных окон при клике вне окна
    window.addEventListener('click', function(e) {
        if (e.target.classList.contains('modal')) {
            e.target.style.display = 'none';
        }
    });

    // Отмена выхода
    if (cancelLogoutBtn) {
        cancelLogoutBtn.addEventListener('click', function() {
            if (logoutModal) {
                logoutModal.style.display = 'none';
            }
        });
    }

    // Подтверждение выхода
    if (confirmLogoutBtn) {
        confirmLogoutBtn.addEventListener('click', function() {
            window.location.href = "{% url 'logout' %}";
        });
    }

    // ========== ОТКРЫТИЕ МОДАЛЬНЫХ ОКОН ВХОДА/РЕГИСТРАЦИИ ==========
    // Обработчики определены в main.js, здесь ничего делать не нужно
});
</script>

<!-- ========== ПЕРЕКЛЮЧЕНИЕ ТЕМНОЙ ТЕМЫ (ГЛОБАЛЬНО) ========== -->
<script>
// Функция переключения темы - глобальная
function toggleTheme() {
    const html = document.documentElement;
    const themeToggle = document.querySelector('.theme-toggle i');
    const currentTheme = html.getAttribute('data-theme');

    if (currentTheme === 'dark') {
        html.setAttribute('data-theme', 'light');
        localStorage.setItem('theme', 'light');
        if (themeToggle) {
            themeToggle.classList.remove('fa-sun');
            themeToggle.classList.add('fa-moon');
        }
    } else {
        html.setAttribute('data-theme', 'dark');
        localStorage.setItem('theme', 'dark');
        if (themeToggle) {
            themeToggle.classList.remove('fa-moon');
            themeToggle.classList.add('fa-sun');
        }
    }
}

// Загружаем сохраненную тему при загрузке страницы
(function() {
    const savedTheme = localStorage.getItem('theme') || 'light';
    const html = document.documentElement;

    if (savedTheme === 'dark') {
        html.setAttribute('data-theme', 'dark');
    }

    // Обновляем иконку после загрузки DOM
    document.addEventListener('DOMContentLoaded', function() {
        const themeToggle = document.querySelector('.theme-toggle i');
        if (themeToggle && savedTheme === 'dark') {
            themeToggle.classList.remove('fa-moon');
            themeToggle.classList.add('fa-sun');
        }
    });
})();
</script>