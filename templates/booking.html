{% extends 'base.html' %}
{% load static %}

{% block title %}Бронирование - Paddle Booking{% endblock %}

{% block extra_css %}
<!-- FullCalendar CSS -->
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css' rel='stylesheet' />
<style>
    /* Компактный календарь */
    .fullcalendar-wrapper {
        background: var(--card-bg);
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 30px;
        transition: background-color 0.3s ease;
    }

    #main-calendar {
        max-width: 100%;
    }

    /* Темная тема для календаря */
    :root[data-theme="dark"] .fullcalendar-wrapper {
        background: var(--card-bg);
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    :root[data-theme="dark"] #main-calendar .fc-scrollgrid {
        border-color: var(--card-border) !important;
    }

    :root[data-theme="dark"] #main-calendar .fc-col-header-cell {
        background: rgba(158, 240, 26, 0.15) !important;
        color: var(--text-color) !important;
        border-color: var(--card-border) !important;
    }

    :root[data-theme="dark"] #main-calendar .fc-daygrid-day {
        background: var(--card-bg) !important;
        border-color: var(--card-border) !important;
    }

    :root[data-theme="dark"] #main-calendar .fc-daygrid-day-number {
        color: var(--text-color) !important;
    }

    :root[data-theme="dark"] #main-calendar .fc-day-other .fc-daygrid-day-number {
        color: var(--gray-color) !important;
        opacity: 0.5;
    }



    /* ========== КОМПАКТНЫЙ FullCalendar ========== */

    #main-calendar {
        position: relative;
        z-index: 1;
    }

    /* Компактный toolbar */
    #main-calendar .fc-toolbar {
        background: linear-gradient(135deg, #9ef01a 0%, #bff167 100%) !important;
        padding: 15px 20px !important;
        border-radius: 12px !important;
        margin-bottom: 15px !important;
        box-shadow: 0 4px 15px rgba(158, 240, 26, 0.3) !important;
    }

    #main-calendar .fc-toolbar-title {
        color: white !important;
        font-weight: 700 !important;
        font-size: 20px !important;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2) !important;
    }

    /* Компактная высота календаря */
    #main-calendar .fc-daygrid {
        height: auto !important;
    }

    #main-calendar .fc-scrollgrid {
        border-radius: 8px !important;
        overflow: hidden !important;
    }

    /* Кнопки календаря */
    #main-calendar .fc-button {
        background-color: white !important;
        color: #38b000 !important;
        border: 2px solid white !important;
        border-radius: 8px !important;
        font-weight: 600 !important;
        padding: 6px 14px !important;
        transition: all 0.3s ease !important;
        text-transform: capitalize !important;
        cursor: pointer !important;
        outline: none !important;
        font-size: 14px !important;
    }

    #main-calendar .fc-button:not(:disabled):hover {
        background-color: #bff167 !important;
        color: white !important;
        border-color: #bff167 !important;
        transform: translateY(-2px) !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
    }

    #main-calendar .fc-button:not(:disabled):active {
        transform: translateY(0) !important;
    }

    #main-calendar .fc-button-primary.fc-button-active,
    #main-calendar .fc-button-primary:not(:disabled).fc-button-active {
        background-color: #7cc00f !important;
        color: white !important;
        border-color: #7cc00f !important;
    }

    #main-calendar .fc-button:disabled {
        opacity: 0.5 !important;
        cursor: not-allowed !important;
    }

    /* Сетка календаря */
    #main-calendar .fc-scrollgrid {
        border: 1px solid #f0f0f0 !important;
    }

    #main-calendar .fc-col-header {
        background: linear-gradient(135deg, rgba(158, 240, 26, 0.1) 0%, rgba(191, 241, 103, 0.1) 100%);
    }

    #main-calendar .fc-col-header-cell {
        padding: 8px 0 !important;
        font-weight: 700 !important;
        font-size: 13px !important;
        color: var(--secondary-color) !important;
        text-transform: uppercase !important;
    }

    #main-calendar .fc-daygrid-day {
        transition: all 0.2s !important;
        cursor: pointer !important;
        min-height: 80px !important;
    }

    #main-calendar .fc-daygrid-day:hover {
        background: rgba(158, 240, 26, 0.05) !important;
    }

    #main-calendar .fc-daygrid-day-number {
        color: #666 !important;
        font-weight: 600 !important;
        padding: 6px !important;
        font-size: 14px !important;
    }

    /* Сегодняшний день */
    #main-calendar .fc-day-today {
        background: linear-gradient(135deg, rgba(158, 240, 26, 0.15) 0%, rgba(191, 241, 103, 0.15) 100%) !important;
    }

    #main-calendar .fc-day-today .fc-daygrid-day-number {
        color: var(--primary-dark) !important;
        font-weight: 700 !important;
        background: white !important;
        border-radius: 50% !important;
        width: 28px !important;
        height: 28px !important;
        display: inline-flex !important;
        align-items: center !important;
        justify-content: center !important;
    }

    /* Выделение выбранной даты */
    #main-calendar .fc-day.selected-date {
        background: rgba(158, 240, 26, 0.2) !important;
        border: 2px solid var(--primary-color) !important;
    }

    /* События/бронирования */
    #main-calendar .fc-event {
        cursor: pointer !important;
        border: none !important;
        padding: 3px 6px !important;
        border-radius: 4px !important;
        font-size: 11px !important;
        font-weight: 600 !important;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1) !important;
        transition: all 0.2s !important;
        margin: 1px 0 !important;
    }

    #main-calendar .fc-event:hover {
        transform: translateY(-1px) !important;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15) !important;
        opacity: 1 !important;
        filter: brightness(1.1) !important;
    }

    /* Выходные дни */
    .fc .fc-day-sat,
    .fc .fc-day-sun {
        background: rgba(255, 152, 0, 0.03);
    }

    /* Временная сетка */
    .fc .fc-timegrid-slot {
        height: 40px;
    }

    .fc .fc-timegrid-slot-label {
        color: #666;
        font-weight: 600;
        font-size: 13px;
    }

    .fc .fc-timegrid-now-indicator-line {
        border-color: var(--primary-color);
        border-width: 2px;
    }

    .fc .fc-timegrid-now-indicator-arrow {
        border-color: var(--primary-color);
    }

    /* Адаптивность */
    @media (max-width: 768px) {
        .fc .fc-toolbar {
            flex-direction: column;
            gap: 10px;
            padding: 15px;
        }

        .fc .fc-toolbar-title {
            font-size: 20px;
        }

        .fc .fc-button {
            font-size: 13px !important;
            padding: 6px 12px !important;
        }
    }

    /* ========== МОДАЛЬНОЕ ОКНО СОБЫТИЯ ========== */
    .event-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(8px);
        z-index: 9999;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease;
    }

    .event-modal.active {
        display: flex;
    }

    .event-modal-content {
        background: white;
        padding: 0;
        border-radius: 16px;
        max-width: 550px;
        width: 90%;
        max-height: 85vh;
        overflow: hidden;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: slideInUp 0.4s ease;
    }

    .event-modal-header {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
        padding: 25px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 3px solid var(--primary-dark);
    }

    .event-modal-header h3 {
        margin: 0;
        color: white;
        font-size: 22px;
        font-weight: 700;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .event-modal-close {
        background: white;
        color: var(--primary-dark);
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        cursor: pointer;
        transition: all 0.3s;
        border: none;
        font-weight: 700;
    }

    .event-modal-close:hover {
        transform: rotate(90deg) scale(1.1);
        background: var(--primary-dark);
        color: white;
    }

    #modalBody {
        padding: 30px;
        overflow-y: auto;
        max-height: calc(85vh - 100px);
    }

    .event-detail {
        display: flex;
        justify-content: space-between;
        padding: 15px 0;
        border-bottom: 1px solid #f0f0f0;
    }

    .event-detail:last-child {
        border-bottom: none;
    }

    .event-detail-label {
        font-weight: 600;
        color: #666;
        font-size: 14px;
    }

    .event-detail-value {
        font-weight: 700;
        color: #333;
        text-align: right;
        font-size: 15px;
    }

    .event-actions {
        margin-top: 20px;
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }

    .btn-event {
        padding: 12px 24px;
        border-radius: 8px;
        border: none;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 14px;
    }

    .btn-view {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        color: white;
    }

    .btn-view:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(108, 117, 125, 0.3);
    }

    .btn-join {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
        color: white;
    }

    .btn-join:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(158, 240, 26, 0.4);
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(50px) scale(0.9);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    /* Темная тема для модального окна */
    :root[data-theme="dark"] .event-modal-content {
        background: var(--card-bg);
    }

    :root[data-theme="dark"] #modalBody {
        background: var(--card-bg);
    }

    :root[data-theme="dark"] .event-detail {
        border-bottom-color: var(--card-border);
    }

    :root[data-theme="dark"] .event-detail-label {
        color: var(--gray-color);
    }

    :root[data-theme="dark"] .event-detail-value {
        color: var(--text-color);
    }

    .event-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .event-modal-close {
        cursor: pointer;
        font-size: 24px;
        color: #6b7280;
    }

    .event-modal-close:hover {
        color: #1a1a1a;
    }

    .event-detail {
        margin-bottom: 15px;
    }

    .event-detail-label {
        font-weight: 600;
        color: #6b7280;
        font-size: 12px;
        text-transform: uppercase;
        margin-bottom: 4px;
    }

    .event-detail-value {
        font-size: 16px;
        color: #1a1a1a;
    }

    .event-actions {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }

    .btn-event {
        flex: 1;
        padding: 12px;
        border-radius: 8px;
        border: none;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-view {
        background: #3b82f6;
        color: white;
    }

    .btn-view:hover {
        background: #2563eb;
    }

    .btn-join {
        background: #10b981;
        color: white;
    }

    .btn-join:hover {
        background: #059669;
    }

    /* Стили для переключателя типа бронирования */
    .type-option .type-card {
        text-align: center;
        padding: 20px 15px;
        border: 3px solid #e5e7eb;
        border-radius: 12px;
        background: white;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .type-option:hover .type-card {
        border-color: var(--primary-color);
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(158, 240, 26, 0.2);
    }

    .type-option.active .type-card {
        border-color: var(--primary-color);
        background: linear-gradient(135deg, rgba(158, 240, 26, 0.1) 0%, rgba(191, 241, 103, 0.1) 100%);
        box-shadow: 0 8px 20px rgba(158, 240, 26, 0.25);
        transform: scale(1.02);
    }

    .type-option .type-card i {
        color: var(--secondary-color);
        transition: all 0.3s;
    }

    .type-option.active .type-card i {
        color: var(--primary-color);
        transform: scale(1.1);
    }

    #coach-selection {
        animation: slideDown 0.4s ease-out;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            max-height: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            max-height: 200px;
            transform: translateY(0);
        }
    }

    /* Стили для выбора количества игроков */
    .player-count-option {
        transition: all 0.3s ease;
    }

    .player-count-option:hover {
        border-color: var(--primary-color) !important;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(158, 240, 26, 0.2);
    }

    .player-count-option.active {
        border-color: var(--primary-color) !important;
        background: linear-gradient(135deg, rgba(158, 240, 26, 0.1) 0%, rgba(191, 241, 103, 0.1) 100%) !important;
        box-shadow: 0 4px 12px rgba(158, 240, 26, 0.3);
    }

    /* Стили для выбора уровней рейтинга */
    .rating-level-option {
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .rating-badge {
        padding: 12px 8px;
        border: 2px solid #ddd;
        border-radius: 8px;
        text-align: center;
        font-weight: 700;
        font-size: 16px;
        color: var(--secondary-color);
        background: white;
        transition: all 0.3s ease;
    }

    .rating-level-option:hover .rating-badge {
        border-color: var(--primary-color);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(158, 240, 26, 0.2);
    }

    .rating-level-option.active .rating-badge {
        border-color: var(--primary-color);
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
        color: var(--secondary-color);
        box-shadow: 0 4px 12px rgba(158, 240, 26, 0.3);
    }

    /* Стили для поиска участников */
    .search-result-item {
        padding: 12px;
        border-bottom: 1px solid #f0f0f0;
        cursor: pointer;
        transition: background 0.2s;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .search-result-item:hover {
        background: rgba(158, 240, 26, 0.1);
    }

    .search-result-item:last-child {
        border-bottom: none;
    }

    .participant-tag {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
        color: var(--secondary-color);
        border-radius: 20px;
        font-size: 13px;
        font-weight: 600;
    }

    .participant-tag .remove-participant {
        cursor: pointer;
        margin-left: 4px;
        opacity: 0.7;
        transition: opacity 0.2s;
    }

    .participant-tag .remove-participant:hover {
        opacity: 1;
    }
</style>
{% endblock %}

{% block content %}

<!-- Индикатор загрузки страницы -->
<div id="page-loader" style="
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.95);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 20px;
">
    <div style="
        width: 60px;
        height: 60px;
        border: 4px solid #f0f0f0;
        border-top: 4px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    "></div>
    <div style="
        font-size: 18px;
        font-weight: 600;
        color: var(--secondary-color);
    ">Загрузка календаря...</div>
</div>

<style>
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

<div class="page-header">
    <h1>Бронирование кортов</h1>
    <p>Выберите дату, корт и время для бронирования</p>
</div>

<!-- ПРИГЛАШЕНИЯ В ИГРУ -->
{% if user.is_authenticated and pending_invitations %}
<div class="invitations-section" style="margin-bottom: 30px;">
    <div class="section-card" style="background: linear-gradient(135deg, rgba(158, 240, 26, 0.1) 0%, rgba(191, 241, 103, 0.1) 100%); border: 2px solid rgba(158, 240, 26, 0.3);">
        <h3 style="color: var(--primary-color);"><i class="fas fa-envelope"></i> Приглашения в игру ({{ pending_invitations|length }})</h3>

        <div class="invitations-list" style="display: grid; gap: 15px;">
            {% for invitation in pending_invitations %}
            <div class="invitation-item" id="invitation-{{ invitation.id }}" style="background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 12px; padding: 16px;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                    <div style="flex: 1; min-width: 200px;">
                        <div style="font-size: 16px; font-weight: 600; color: var(--text-color); margin-bottom: 8px;">
                            <i class="fas fa-user"></i> {{ invitation.inviter.get_full_name|default:invitation.inviter.username }}
                            приглашает вас
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 8px; font-size: 14px; color: var(--gray-color);">
                            <div><i class="fas fa-calendar"></i> {{ invitation.booking.date|date:"d.m.Y" }}</div>
                            <div><i class="fas fa-clock"></i> {{ invitation.booking.start_time|time:"H:i" }} - {{ invitation.booking.end_time|time:"H:i" }}</div>
                            <div><i class="fas fa-map-marker-alt"></i> {{ invitation.booking.court.name }}</div>
                        </div>
                        {% if invitation.message %}
                        <div style="margin-top: 8px; padding: 8px 12px; background: rgba(158, 240, 26, 0.05); border-left: 3px solid var(--primary-color); border-radius: 4px; font-size: 13px; color: var(--gray-color);">
                            <i class="fas fa-comment"></i> {{ invitation.message }}
                        </div>
                        {% endif %}
                    </div>
                    <div style="display: flex; gap: 10px; flex-shrink: 0;">
                        <button class="btn-primary" onclick="acceptInvitation({{ invitation.id }})" style="padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 600;">
                            <i class="fas fa-check"></i> Принять
                        </button>
                        <button class="btn-secondary" onclick="declineInvitation({{ invitation.id }})" style="padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 600;">
                            <i class="fas fa-times"></i> Отклонить
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- КАЛЕНДАРЬ FULLCALENDAR -->
<div class="fullcalendar-wrapper">
    <div id="main-calendar"></div>
</div>

<!-- ГОРИЗОНТАЛЬНЫЙ ВЫБОР КОРТОВ -->
<div class="courts-horizontal-container">
    <div class="section-card">
        <h3><i class="fas fa-court-sport"></i> Выберите корт</h3>

        <div id="courts-horizontal-list" class="courts-horizontal-list">
            {% for court in courts %}
            <div class="court-horizontal-item {% if forloop.first %}active{% endif %}"
                 data-court-id="{{ court.id }}"
                 data-court-price="{{ court.price_per_hour }}"
                 onclick="selectCourt(this, {{ court.id }}, {{ court.price_per_hour }})"
                 style="cursor: pointer;">

                <div class="court-horizontal-image">
                    <i class="fas fa-tennis-ball"></i>
                </div>
                <div class="court-horizontal-info">
                    <h4>{{ court.name }}</h4>
                    <span class="court-price">{{ court.price_per_hour }} ₽/час</span>
                    <p class="court-description">{{ court.description|truncatechars:60 }}</p>
                    <div class="court-status">
                        {% if court.is_available %}
                        <span class="status-available"><i class="fas fa-check-circle"></i> Доступен</span>
                        {% else %}
                        <span class="status-unavailable"><i class="fas fa-times-circle"></i> Недоступен</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="no-courts">
                <i class="fas fa-tennis-ball"></i>
                <p>Нет доступных кортов в данный момент</p>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- ВРЕМЕННЫЕ СЛОТЫ С РАЗДЕЛАМИ -->
<div class="time-slots-container">
    <div class="section-card">
        <h3><i class="fas fa-clock"></i> Доступное время</h3>

        <div id="time-slots-sections" class="time-slots-sections">
            <!-- УТРО -->
            <div class="time-section morning-section">
                <div class="section-header" data-section="morning">
                    <h4><i class="fas fa-sun"></i> Утро (8:00 - 12:00)</h4>
                    <span class="toggle-arrow"><i class="fas fa-chevron-down"></i></span>
                </div>
                <div class="section-content" id="morning-slots" style="display: block;">
                    <div class="select-court-date">
                        <i class="fas fa-calendar-check"></i>
                        <p>Выберите дату и корт, чтобы увидеть доступное время</p>
                    </div>
                </div>
            </div>

            <!-- ДЕНЬ -->
            <div class="time-section day-section">
                <div class="section-header" data-section="day">
                    <h4><i class="fas fa-cloud-sun"></i> День (12:00 - 17:00)</h4>
                    <span class="toggle-arrow"><i class="fas fa-chevron-down"></i></span>
                </div>
                <div class="section-content" id="day-slots" style="display: block;">
                    <div class="select-court-date">
                        <i class="fas fa-calendar-check"></i>
                        <p>Выберите дату и корт, чтобы увидеть доступное время</p>
                    </div>
                </div>
            </div>

            <!-- ВЕЧЕР -->
            <div class="time-section evening-section">
                <div class="section-header" data-section="evening">
                    <h4><i class="fas fa-moon"></i> Вечер (17:00 - 22:00)</h4>
                    <span class="toggle-arrow"><i class="fas fa-chevron-down"></i></span>
                </div>
                <div class="section-content" id="evening-slots" style="display: block;">
                    <div class="select-court-date">
                        <i class="fas fa-calendar-check"></i>
                        <p>Выберите дату и корт, чтобы увидеть доступное время</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- СТАТИСТИКА ВЫБРАННОГО ВРЕМЕНИ -->
<div id="selected-time-info" class="selected-time-info" style="display: none;">
    <div class="section-card">
        <h3><i class="fas fa-check-circle"></i> Выбранное время</h3>
        <div class="selected-details">
            <div class="selected-item">
                <span class="label">Корт:</span>
                <span id="selected-court" class="value"></span>
            </div>
            <div class="selected-item">
                <span class="label">Дата:</span>
                <span id="selected-date" class="value"></span>
            </div>
            <div class="selected-item">
                <span class="label">Время:</span>
                <span id="selected-time" class="value"></span>
            </div>
            <div class="selected-item">
                <span class="label">Стоимость:</span>
                <span id="selected-price" class="value"></span>
            </div>
            <button id="confirm-booking-btn" class="btn-primary">Забронировать</button>
        </div>
    </div>
</div>

<!-- Модальное окно подтверждения бронирования -->
<div id="bookingConfirmModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close-modal">&times;</span>
        <h2>Подтверждение бронирования</h2>
        <div class="booking-details">
            <div class="booking-detail-item">
                <span class="detail-label">Корт:</span>
                <span id="modal-court-name" class="detail-value"></span>
            </div>
            <div class="booking-detail-item">
                <span class="detail-label">Дата:</span>
                <span id="modal-date" class="detail-value"></span>
            </div>
            <div class="booking-detail-item">
                <span class="detail-label">Время:</span>
                <span id="modal-time" class="detail-value"></span>
            </div>
            <div class="booking-detail-item">
                <span class="detail-label">Стоимость:</span>
                <span id="modal-price" class="detail-value"></span>
            </div>
        </div>

        <form id="booking-form" method="post" action="{% url 'create_booking' %}">
            {% csrf_token %}
            <input type="hidden" name="court_id" id="form-court-id">
            <input type="hidden" name="date" id="form-date">
            <input type="hidden" name="start_time" id="form-start-time">
            <input type="hidden" name="end_time" id="form-end-time">
            <input type="hidden" name="duration" id="form-duration" value="1">

            <!-- Тип бронирования -->
            <div class="booking-type-selector" style="margin: 20px 0;">
                <label style="display: block; margin-bottom: 12px; font-weight: 600; color: var(--secondary-color); font-size: 15px;">
                    <i class="fas fa-clipboard-list"></i> Тип бронирования:
                </label>
                <div style="display: flex; gap: 12px;">
                    <label class="type-option active" style="flex: 1; cursor: pointer;">
                        <input type="radio" name="booking_type" value="game" checked style="display: none;">
                        <div class="type-card">
                            <i class="fas fa-users" style="font-size: 24px; margin-bottom: 8px;"></i>
                            <span style="font-weight: 600; font-size: 15px;">Игра</span>
                            <small style="display: block; font-size: 12px; color: #666; margin-top: 4px;">Играть с друзьями</small>
                        </div>
                    </label>
                    <label class="type-option" style="flex: 1; cursor: pointer;">
                        <input type="radio" name="booking_type" value="training" style="display: none;">
                        <div class="type-card">
                            <i class="fas fa-dumbbell" style="font-size: 24px; margin-bottom: 8px;"></i>
                            <span style="font-weight: 600; font-size: 15px;">Тренировка</span>
                            <small style="display: block; font-size: 12px; color: #666; margin-top: 4px;">С тренером</small>
                        </div>
                    </label>
                </div>
            </div>

            <!-- Ищу партнера (показывается только для игр) -->
            <div id="partner-search-section" style="margin: 20px 0; padding: 15px; background: linear-gradient(135deg, #f0f8ff 0%, #e6f2ff 100%); border-radius: 12px; border: 2px solid #b3d9ff;">
                <label style="display: flex; align-items: center; cursor: pointer; user-select: none;">
                    <input type="checkbox" name="looking_for_partner" id="looking-for-partner" value="1" style="
                        width: 20px;
                        height: 20px;
                        margin-right: 12px;
                        cursor: pointer;
                        accent-color: var(--primary-color);
                    ">
                    <div style="flex: 1;">
                        <span style="font-weight: 600; color: var(--secondary-color); font-size: 15px;">
                            <i class="fas fa-user-plus"></i> Ищу партнера для игры
                        </span>
                        <small style="display: block; font-size: 12px; color: #666; margin-top: 4px;">
                            Ваше бронирование будет видно другим игрокам, которые ищут партнера
                        </small>
                    </div>
                </label>

                <!-- Параметры поиска партнёра (показываются только если чекбокс отмечен) -->
                <div id="partner-params" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #b3d9ff;">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--secondary-color); font-size: 14px;">
                            <i class="fas fa-users"></i> Ищу партнёров (количество):
                        </label>
                        <div style="display: flex; gap: 10px;">
                            <label class="player-count-option active" style="flex: 1; cursor: pointer; text-align: center; padding: 12px; border: 2px solid #ddd; border-radius: 8px; background: white; transition: all 0.3s;">
                                <input type="radio" name="max_players" value="2" checked style="display: none;">
                                <div style="font-size: 20px; font-weight: 700; color: var(--primary-color);">1</div>
                                <div style="font-size: 11px; color: #666; margin-top: 4px;">партнёр</div>
                            </label>
                            <label class="player-count-option" style="flex: 1; cursor: pointer; text-align: center; padding: 12px; border: 2px solid #ddd; border-radius: 8px; background: white; transition: all 0.3s;">
                                <input type="radio" name="max_players" value="3" style="display: none;">
                                <div style="font-size: 20px; font-weight: 700; color: var(--primary-color);">2</div>
                                <div style="font-size: 11px; color: #666; margin-top: 4px;">партнёра</div>
                            </label>
                            <label class="player-count-option" style="flex: 1; cursor: pointer; text-align: center; padding: 12px; border: 2px solid #ddd; border-radius: 8px; background: white; transition: all 0.3s;">
                                <input type="radio" name="max_players" value="4" style="display: none;">
                                <div style="font-size: 20px; font-weight: 700; color: var(--primary-color);">3</div>
                                <div style="font-size: 11px; color: #666; margin-top: 4px;">партнёра</div>
                            </label>
                        </div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600; color: var(--secondary-color); font-size: 14px;">
                            <i class="fas fa-star"></i> Требуемые уровни игры (можно выбрать 1-3):
                        </label>
                        <div id="rating-levels-grid" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px;">
                            <label class="rating-level-option" data-level="D">
                                <input type="checkbox" name="required_rating_levels" value="D" style="display: none;">
                                <div class="rating-badge">D</div>
                            </label>
                            <label class="rating-level-option" data-level="D+">
                                <input type="checkbox" name="required_rating_levels" value="D+" style="display: none;">
                                <div class="rating-badge">D+</div>
                            </label>
                            <label class="rating-level-option" data-level="C-">
                                <input type="checkbox" name="required_rating_levels" value="C-" style="display: none;">
                                <div class="rating-badge">C-</div>
                            </label>
                            <label class="rating-level-option" data-level="C">
                                <input type="checkbox" name="required_rating_levels" value="C" style="display: none;">
                                <div class="rating-badge">C</div>
                            </label>
                            <label class="rating-level-option" data-level="C+">
                                <input type="checkbox" name="required_rating_levels" value="C+" style="display: none;">
                                <div class="rating-badge">C+</div>
                            </label>
                            <label class="rating-level-option" data-level="B-">
                                <input type="checkbox" name="required_rating_levels" value="B-" style="display: none;">
                                <div class="rating-badge">B-</div>
                            </label>
                            <label class="rating-level-option" data-level="B">
                                <input type="checkbox" name="required_rating_levels" value="B" style="display: none;">
                                <div class="rating-badge">B</div>
                            </label>
                            <label class="rating-level-option" data-level="B+">
                                <input type="checkbox" name="required_rating_levels" value="B+" style="display: none;">
                                <div class="rating-badge">B+</div>
                            </label>
                            <label class="rating-level-option" data-level="A">
                                <input type="checkbox" name="required_rating_levels" value="A" style="display: none;">
                                <div class="rating-badge">A</div>
                            </label>
                            <label class="rating-level-option" data-level="PRO">
                                <input type="checkbox" name="required_rating_levels" value="PRO" style="display: none;">
                                <div class="rating-badge">PRO</div>
                            </label>
                        </div>
                        <small style="display: block; margin-top: 8px; color: #666; font-size: 12px;">
                            <i class="fas fa-info-circle"></i> Выберите 1-3 уровня или оставьте пустым для любого уровня
                        </small>
                    </div>

                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--secondary-color); font-size: 14px;">
                            <i class="fas fa-user-plus"></i> Пригласить участников (опционально):
                        </label>
                        <div style="position: relative;">
                            <input type="text" id="participant-search" placeholder="Поиск по имени, фамилии или телефону..." style="width: 100%; padding: 12px 40px 12px 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;">
                            <i class="fas fa-search" style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #999;"></i>
                        </div>
                        <div id="search-results" style="display: none; margin-top: 8px; max-height: 200px; overflow-y: auto; border: 2px solid #ddd; border-radius: 8px; background: white;"></div>
                        <div id="selected-participants" style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px;"></div>
                        <input type="hidden" id="invited-participants" name="invited_participants" value="">
                    </div>
                </div>
            </div>

            <!-- Выбор тренера (показывается только для тренировок) -->
            <div id="coach-selection" style="display: none; margin: 20px 0; padding: 15px; background: linear-gradient(135deg, #fff8f0 0%, #fff5e6 100%); border-radius: 12px; border: 2px solid #ffe0b3;">
                <label style="display: block; margin-bottom: 12px; font-weight: 600; color: var(--secondary-color); font-size: 15px;">
                    <i class="fas fa-user-tie"></i> Выберите тренера:
                </label>
                <select name="coach" id="coach-select" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; background: white;">
                    <option value="">Без тренера</option>
                    {% comment %}
                    <!-- Тренеры будут загружены через AJAX -->
                    {% endcomment %}
                </select>
                <small style="display: block; margin-top: 8px; color: #666; font-size: 13px;">
                    <i class="fas fa-info-circle"></i> Выбор тренера изменит стоимость бронирования
                </small>
            </div>

            <div class="form-actions">
                <button type="button" class="btn-secondary cancel-booking">Отмена</button>
                <button type="submit" class="btn-primary confirm-booking">Подтвердить бронирование</button>
            </div>
        </form>
    </div>
</div>

<!-- Модальное окно с деталями события (при клике на бронь в календаре) -->
<div id="eventDetailsModal" class="modal" style="display: none;">
    <div class="modal-content event-details-content">
        <span class="close-modal">&times;</span>
        <div class="event-header">
            <h2><i class="fas fa-calendar-check"></i> Информация о бронировании</h2>
            <span class="event-status-badge" id="event-status-badge">Подтверждено</span>
        </div>

        <div class="event-details-grid">
            <div class="event-detail-card">
                <div class="event-detail-icon court-icon">
                    <i class="fas fa-map-marker-alt"></i>
                </div>
                <div class="event-detail-content">
                    <span class="event-detail-label">Корт</span>
                    <span class="event-detail-value" id="event-court-name">-</span>
                </div>
            </div>

            <div class="event-detail-card">
                <div class="event-detail-icon date-icon">
                    <i class="fas fa-calendar"></i>
                </div>
                <div class="event-detail-content">
                    <span class="event-detail-label">Дата</span>
                    <span class="event-detail-value" id="event-date">-</span>
                </div>
            </div>

            <div class="event-detail-card">
                <div class="event-detail-icon time-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="event-detail-content">
                    <span class="event-detail-label">Время</span>
                    <span class="event-detail-value" id="event-time">-</span>
                </div>
            </div>

            <div class="event-detail-card">
                <div class="event-detail-icon user-icon">
                    <i class="fas fa-user"></i>
                </div>
                <div class="event-detail-content">
                    <span class="event-detail-label">Организатор</span>
                    <span class="event-detail-value" id="event-creator">-</span>
                </div>
            </div>

            <div class="event-detail-card">
                <div class="event-detail-icon price-icon">
                    <i class="fas fa-ruble-sign"></i>
                </div>
                <div class="event-detail-content">
                    <span class="event-detail-label">Стоимость</span>
                    <span class="event-detail-value" id="event-price">-</span>
                </div>
            </div>

            <div class="event-detail-card">
                <div class="event-detail-icon players-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="event-detail-content">
                    <span class="event-detail-label">Игроки</span>
                    <span class="event-detail-value" id="event-players">-</span>
                </div>
            </div>
        </div>

        <div class="event-actions" id="event-actions">
            <!-- Кнопки будут добавлены динамически в зависимости от статуса брони -->
        </div>
    </div>
</div>

<style>
    /* Стили для календаря */
    .calendar-container {
        margin-bottom: 30px;
    }

    /* ГОРИЗОНТАЛЬНЫЙ ВЫБОР КОРТОВ */
    .courts-horizontal-container {
        margin-bottom: 30px;
    }

    .courts-horizontal-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .court-horizontal-item {
        background: white;
        border-radius: 15px;
        padding: 25px;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 3px solid #eee;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
    }

    .court-horizontal-item:hover {
        transform: translateY(-8px);
        box-shadow: 0 15px 30px rgba(158, 240, 26, 0.15);
        border-color: #bff167;
    }

    .court-horizontal-item.active {
        border-color: #9ef01a;
        background: linear-gradient(135deg, rgba(158, 240, 26, 0.05) 0%, rgba(191, 241, 103, 0.05) 100%);
        box-shadow: 0 15px 35px rgba(158, 240, 26, 0.2);
    }

    .court-horizontal-image {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: linear-gradient(135deg, #9ef01a 0%, #bff167 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 20px;
    }

    .court-horizontal-image i {
        font-size: 40px;
        color: white;
    }

    .court-horizontal-info h4 {
        margin: 0 0 10px 0;
        color: #333;
        font-size: 20px;
        font-weight: 700;
    }

    .court-price {
        display: inline-block;
        background: linear-gradient(135deg, #9ef01a 0%, #bff167 100%);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 700;
        font-size: 16px;
        margin-bottom: 15px;
        box-shadow: 0 3px 8px rgba(158, 240, 26, 0.3);
    }

    .court-description {
        color: #666;
        font-size: 14px;
        line-height: 1.5;
        margin-bottom: 15px;
        min-height: 40px;
    }

    .court-status {
        font-size: 14px;
        font-weight: 600;
    }

    .status-available {
        color: #38b000;
    }

    .status-unavailable {
        color: #dc3545;
    }

    /* ВРЕМЕННЫЕ СЛОТЫ С РАЗДЕЛАМИ */
    .time-slots-container {
        margin-bottom: 30px;
    }

    .time-slots-sections {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .time-section {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        border: 2px solid #f0f0f0;
        transition: all 0.3s ease;
    }

    .time-section.morning-section .section-header {
        background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
    }

    .time-section.day-section .section-header {
        background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
    }

    .time-section.evening-section .section-header {
        background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%);
    }

    .section-header {
        padding: 20px 25px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: white;
        user-select: none;
    }

    .section-header h4 {
        margin: 0;
        font-size: 18px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .section-header h4 i {
        font-size: 20px;
    }

    .toggle-arrow {
        transition: transform 0.3s ease;
    }

    .section-content {
        padding: 25px;
        animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* СЕТКА ВРЕМЕННЫХ СЛОТОВ */
    .time-slots-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 15px;
    }

    .time-slot-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 3px solid #eee;
        text-align: center;
        position: relative;
    }

    .time-slot-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }

    .time-slot-card.available {
        border-color: #bff167;
    }

    .time-slot-card.available:hover {
        background: linear-gradient(135deg, #9ef01a 0%, #bff167 100%);
        border-color: #9ef01a;
    }

    .time-slot-card.available:hover .slot-time,
    .time-slot-card.available:hover .slot-price {
        color: white;
    }

    .time-slot-card.unavailable {
        opacity: 0.5;
        cursor: not-allowed;
        background: #f8f8f8;
    }

    .slot-time {
        display: block;
        font-weight: 700;
        color: #333;
        font-size: 18px;
        margin-bottom: 8px;
    }

    .slot-price {
        display: block;
        font-size: 16px;
        color: #38b000;
        font-weight: 600;
        margin-bottom: 5px;
    }

    .slot-status {
        font-size: 12px;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .time-slot-card.available .slot-status {
        color: #38b000;
    }

    .time-slot-card.unavailable .slot-status {
        color: #dc3545;
    }

    /* СТАТИСТИКА ВЫБРАННОГО ВРЕМЕНИ */
    .selected-time-info {
        margin-top: 30px;
        animation: slideUp 0.5s ease;
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .selected-details {
        background: linear-gradient(135deg, #f8fff8 0%, #f0fff0 100%);
        border-radius: 12px;
        padding: 25px;
        border: 2px solid #bff167;
    }

    .selected-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 0;
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }

    .selected-item:last-child {
        border-bottom: none;
        padding-top: 20px;
        margin-top: 10px;
    }

    .selected-item .label {
        font-weight: 600;
        color: #555;
        font-size: 16px;
    }

    .selected-item .value {
        font-weight: 700;
        color: #333;
        font-size: 18px;
    }

    #confirm-booking-btn {
        width: 100%;
        margin-top: 10px;
        padding: 15px;
        font-size: 18px;
        font-weight: 700;
    }

    /* СООБЩЕНИЯ */
    .select-court-date {
        text-align: center;
        padding: 40px 20px;
        color: #888;
        grid-column: 1 / -1;
    }

    .select-court-date i {
        font-size: 48px;
        margin-bottom: 15px;
        color: #ccc;
    }

    .select-court-date p {
        margin: 0;
        font-size: 16px;
    }

    .loading {
        text-align: center;
        padding: 30px;
        color: #666;
        grid-column: 1 / -1;
    }

    .loading i {
        margin-right: 10px;
    }

    .error-message {
        text-align: center;
        padding: 30px;
        color: #dc3545;
        grid-column: 1 / -1;
    }

    .error-message i {
        margin-right: 10px;
    }

    /* АДАПТИВНОСТЬ */
    @media (max-width: 1200px) {
        .courts-horizontal-list {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 768px) {
        .courts-horizontal-list {
            grid-template-columns: 1fr;
        }

        .time-slots-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .section-header {
            padding: 15px 20px;
        }

        .section-header h4 {
            font-size: 16px;
        }

        .time-slot-card {
            padding: 15px;
        }

        .slot-time {
            font-size: 16px;
        }
    }

    @media (max-width: 480px) {
        .time-slots-grid {
            grid-template-columns: 1fr;
        }

        .court-horizontal-item {
            padding: 20px;
        }

        .selected-item {
            flex-direction: column;
            align-items: flex-start;
            gap: 5px;
        }

        .selected-item .value {
            font-size: 16px;
        }
    }

    /* ========== МОДАЛЬНОЕ ОКНО С ДЕТАЛЯМИ СОБЫТИЯ ========== */
    .event-details-content {
        max-width: 600px;
        width: 90%;
    }

    .event-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 25px;
        padding-bottom: 20px;
        border-bottom: 2px solid var(--card-border);
    }

    .event-header h2 {
        margin: 0;
        color: var(--secondary-color);
        font-size: 1.6rem;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .event-header i {
        color: var(--primary-color);
    }

    .event-status-badge {
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .event-status-badge.status-confirmed {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.2) 100%);
        color: #10b981;
        border: 2px solid rgba(16, 185, 129, 0.3);
    }

    .event-status-badge.status-pending {
        background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(245, 158, 11, 0.2) 100%);
        color: #f59e0b;
        border: 2px solid rgba(245, 158, 11, 0.3);
    }

    .event-status-badge.status-cancelled {
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(239, 68, 68, 0.2) 100%);
        color: #ef4444;
        border: 2px solid rgba(239, 68, 68, 0.3);
    }

    .event-details-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        margin-bottom: 25px;
    }

    .event-detail-card {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 12px;
        padding: 16px;
        display: flex;
        align-items: center;
        gap: 12px;
        transition: all 0.3s;
    }

    .event-detail-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .event-detail-icon {
        width: 45px;
        height: 45px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        flex-shrink: 0;
    }

    .event-detail-icon.court-icon {
        background: linear-gradient(135deg, rgba(158, 240, 26, 0.1) 0%, rgba(191, 241, 103, 0.2) 100%);
        color: var(--primary-color);
    }

    .event-detail-icon.date-icon {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(59, 130, 246, 0.2) 100%);
        color: #3b82f6;
    }

    .event-detail-icon.time-icon {
        background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(245, 158, 11, 0.2) 100%);
        color: #f59e0b;
    }

    .event-detail-icon.user-icon {
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(139, 92, 246, 0.2) 100%);
        color: #8b5cf6;
    }

    .event-detail-icon.price-icon {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.2) 100%);
        color: #10b981;
    }

    .event-detail-icon.players-icon {
        background: linear-gradient(135deg, rgba(236, 72, 153, 0.1) 0%, rgba(236, 72, 153, 0.2) 100%);
        color: #ec4899;
    }

    .event-detail-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .event-detail-label {
        font-size: 0.8rem;
        color: var(--gray-color);
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .event-detail-value {
        font-size: 1rem;
        color: var(--secondary-color);
        font-weight: 600;
    }

    .event-actions {
        display: flex;
        gap: 12px;
        padding-top: 20px;
        border-top: 2px solid var(--card-border);
    }

    .event-action-btn {
        flex: 1;
        padding: 14px 24px;
        border-radius: 10px;
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        text-decoration: none;
    }

    .event-action-btn.btn-primary {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
        color: var(--secondary-color);
    }

    .event-action-btn.btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(158, 240, 26, 0.3);
    }

    .event-action-btn.btn-secondary {
        background: var(--card-bg);
        color: var(--gray-color);
        border: 2px solid var(--card-border);
    }

    .event-action-btn.btn-secondary:hover {
        background: var(--gray-light);
        transform: translateY(-2px);
    }

    /* Темная тема для модального окна событий */
    :root[data-theme="dark"] .event-header h2 {
        color: var(--text-color);
    }

    :root[data-theme="dark"] .event-detail-card {
        background: rgba(255, 255, 255, 0.05);
        border-color: var(--card-border);
    }

    :root[data-theme="dark"] .event-detail-value {
        color: var(--text-color);
    }

    /* Адаптивность */
    @media (max-width: 768px) {
        .event-details-grid {
            grid-template-columns: 1fr;
        }

        .event-header {
            flex-direction: column;
            gap: 15px;
            align-items: flex-start;
        }

        .event-header h2 {
            font-size: 1.3rem;
        }

        .event-actions {
            flex-direction: column;
        }
    }
</style>

<script>
// Простая функция для быстрой проверки кликабельности
function selectCourt(element, courtId, courtPrice) {
    console.log('Корт кликнут!', courtId, courtPrice);

    // Убираем активный класс у всех кортов
    document.querySelectorAll('.court-horizontal-item').forEach(item => {
        item.classList.remove('active');
        item.style.borderColor = '#eee';
        item.style.boxShadow = '0 5px 15px rgba(0, 0, 0, 0.08)';
    });

    // Добавляем активный класс выбранному
    element.classList.add('active');
    element.style.borderColor = '#9ef01a';
    element.style.boxShadow = '0 15px 35px rgba(158, 240, 26, 0.2)';

    // Обновляем выбранный корт в глобальных переменных
    if (window.selectedCourtData) {
        window.selectedCourtData = {
            id: courtId,
            price: courtPrice,
            name: element.querySelector('h4').textContent
        };
    }

    // Загружаем слоты для выбранного корта
    if (window.selectedDate && window.loadTimeSlots) {
        const dateStr = window.formatDate ? window.formatDate(window.selectedDate) : new Date().toISOString().split('T')[0];
        window.loadTimeSlots(courtId, dateStr);
    }
}
</script>

<!-- ПРОСТОЙ И НАДЕЖНЫЙ СКРИПТ ДЛЯ СЕКЦИЙ -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('🎯 Section handler loaded');

    // Функция для обработки кликов на заголовках
    function setupSectionHandlers() {
        const sections = ['morning', 'day', 'evening'];

        sections.forEach(section => {
            const header = document.querySelector(`[data-section="${section}"]`);
            const content = document.getElementById(`${section}-slots`);

            if (!header || !content) {
                console.log(`❌ Section ${section} not found`);
                return;
            }

            // Удаляем все старые обработчики
            const newHeader = header.cloneNode(true);
            header.parentNode.replaceChild(newHeader, header);

            const newContent = content.cloneNode(true);
            content.parentNode.replaceChild(newContent, content);

            // Получаем обновленные элементы
            const currentHeader = document.querySelector(`[data-section="${section}"]`);
            const currentContent = document.getElementById(`${section}-slots`);

            // Обработчик клика
            currentHeader.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log(`🎯 Clicked ${section} section`);

                if (currentContent.style.display === 'none') {
                    currentContent.style.display = 'block';
                    const arrow = this.querySelector('.toggle-arrow i');
                    if (arrow) arrow.className = 'fas fa-chevron-down';
                    console.log(`✅ ${section} opened`);
                } else {
                    currentContent.style.display = 'none';
                    const arrow = this.querySelector('.toggle-arrow i');
                    if (arrow) arrow.className = 'fas fa-chevron-right';
                    console.log(`✅ ${section} closed`);
                }
            });

            currentHeader.style.cursor = 'pointer';
        });

        console.log('✅ All sections initialized');
    }

    // Запускаем после загрузки страницы
    setTimeout(setupSectionHandlers, 100);

    // ========== УПРАВЛЕНИЕ ТИПОМ БРОНИРОВАНИЯ ==========
    const typeOptions = document.querySelectorAll('.type-option');
    const coachSelection = document.getElementById('coach-selection');
    const partnerSearchSection = document.getElementById('partner-search-section');
    const coachSelect = document.getElementById('coach-select');

    // Переключение между типами бронирования
    typeOptions.forEach(option => {
        option.addEventListener('click', function() {
            // Убираем активный класс у всех опций
            typeOptions.forEach(opt => opt.classList.remove('active'));

            // Добавляем активный класс к выбранной опции
            this.classList.add('active');

            // Отмечаем соответствующий radio button
            const radio = this.querySelector('input[type="radio"]');
            if (radio) {
                radio.checked = true;

                // Показываем/скрываем секции в зависимости от типа
                if (radio.value === 'training') {
                    // Тренировка: показываем выбор тренера, скрываем поиск партнера
                    if (coachSelection) coachSelection.style.display = 'block';
                    if (partnerSearchSection) partnerSearchSection.style.display = 'none';

                    // Загружаем список тренеров
                    loadCoaches();
                } else {
                    // Игра: показываем поиск партнера, скрываем выбор тренера
                    if (coachSelection) coachSelection.style.display = 'none';
                    if (partnerSearchSection) partnerSearchSection.style.display = 'block';
                    if (coachSelect) coachSelect.value = '';
                }
            }
        });
    });

    // Загрузка списка тренеров
    function loadCoaches() {
        fetch('/booking/api/coaches/')
            .then(response => response.json())
            .then(data => {
                const select = document.getElementById('coach-select');
                if (!select) return;

                // Очищаем предыдущие опции (кроме "Без тренера")
                select.innerHTML = '<option value="">Без тренера (опционально)</option>';

                // Добавляем тренеров
                data.coaches.forEach(coach => {
                    const option = document.createElement('option');
                    option.value = coach.id;
                    option.textContent = `${coach.name} (⭐ ${coach.rating}) - ${coach.hourly_rate}₽/час`;
                    option.dataset.rate = coach.hourly_rate;
                    select.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Ошибка загрузки тренеров:', error);
            });
    }

    // ========== УПРАВЛЕНИЕ ПАРАМЕТРАМИ ПОИСКА ПАРТНЁРА ==========
    const lookingForPartnerCheckbox = document.getElementById('looking-for-partner');
    const partnerParams = document.getElementById('partner-params');

    if (lookingForPartnerCheckbox && partnerParams) {
        lookingForPartnerCheckbox.addEventListener('change', function() {
            if (this.checked) {
                partnerParams.style.display = 'block';
                partnerParams.style.animation = 'slideDown 0.3s ease-out';
            } else {
                partnerParams.style.display = 'none';
            }
        });
    }

    // ========== УПРАВЛЕНИЕ ВЫБОРОМ КОЛИЧЕСТВА ИГРОКОВ ==========
    const playerCountOptions = document.querySelectorAll('.player-count-option');
    playerCountOptions.forEach(option => {
        option.addEventListener('click', function() {
            playerCountOptions.forEach(opt => opt.classList.remove('active'));
            this.classList.add('active');
            const radio = this.querySelector('input[type="radio"]');
            if (radio) radio.checked = true;
        });
    });

    // ========== УПРАВЛЕНИЕ ВЫБОРОМ УРОВНЕЙ РЕЙТИНГА ==========
    const ratingLevelOptions = document.querySelectorAll('.rating-level-option');
    const MAX_RATING_SELECTIONS = 3;

    ratingLevelOptions.forEach(option => {
        option.addEventListener('click', function(e) {
            e.preventDefault();
            const checkbox = this.querySelector('input[type="checkbox"]');
            const currentlySelected = document.querySelectorAll('.rating-level-option.active').length;

            if (this.classList.contains('active')) {
                // Снять выбор
                this.classList.remove('active');
                checkbox.checked = false;
            } else {
                // Проверяем лимит
                if (currentlySelected >= MAX_RATING_SELECTIONS) {
                    if (window.toast) {
                        window.toast.warning(`Можно выбрать максимум ${MAX_RATING_SELECTIONS} уровня`);
                    } else {
                        alert(`Можно выбрать максимум ${MAX_RATING_SELECTIONS} уровня`);
                    }
                    return;
                }
                // Добавить выбор
                this.classList.add('active');
                checkbox.checked = true;
            }
        });
    });

    // ========== УМНЫЙ ПОИСК УЧАСТНИКОВ ==========
    const participantSearch = document.getElementById('participant-search');
    const searchResults = document.getElementById('search-results');
    const selectedParticipants = document.getElementById('selected-participants');
    const invitedParticipantsInput = document.getElementById('invited-participants');
    let selectedParticipantIds = [];

    console.log('🔧 Инициализация поиска участников:', {
        participantSearch: !!participantSearch,
        searchResults: !!searchResults,
        selectedParticipants: !!selectedParticipants,
        invitedParticipantsInput: !!invitedParticipantsInput
    });

    if (participantSearch && searchResults) {
        let searchTimeout;
        participantSearch.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const query = this.value.trim();

            if (query.length < 2) {
                searchResults.style.display = 'none';
                return;
            }

            searchTimeout = setTimeout(() => {
                console.log('🔍 Поиск участников:', query);
                fetch(`/booking/api/search-users/?q=${encodeURIComponent(query)}`)
                    .then(response => {
                        console.log('📡 Ответ сервера:', response.status);
                        return response.json();
                    })
                    .then(data => {
                        console.log('📊 Данные поиска:', data);
                        if (data.users && data.users.length > 0) {
                            searchResults.innerHTML = data.users.map(user => {
                                const isCurrentUser = user.is_current_user;
                                const disabledClass = isCurrentUser ? 'disabled' : '';
                                const currentUserLabel = isCurrentUser ? '<span style="background: #f59e0b; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-left: 8px;">Это вы</span>' : '';

                                return `
                                    <div class="search-result-item ${disabledClass}"
                                         data-user-id="${user.id}"
                                         data-user-name="${user.full_name}"
                                         data-user-phone="${user.phone}"
                                         data-is-current="${isCurrentUser}"
                                         style="${isCurrentUser ? 'opacity: 0.6; cursor: not-allowed;' : ''}">
                                        <i class="fas fa-user-circle" style="font-size: 24px; color: var(--primary-color);"></i>
                                        <div style="flex: 1;">
                                            <div style="font-weight: 600; display: flex; align-items: center;">
                                                ${user.full_name}
                                                ${currentUserLabel}
                                            </div>
                                            <div style="font-size: 12px; color: #666;">${user.phone}</div>
                                        </div>
                                    </div>
                                `;
                            }).join('');
                            searchResults.style.display = 'block';

                            // Добавляем обработчики клика
                            searchResults.querySelectorAll('.search-result-item').forEach(item => {
                                item.addEventListener('click', function() {
                                    // Проверяем, не пытается ли пользователь добавить себя
                                    const isCurrent = this.dataset.isCurrent === 'true';
                                    if (isCurrent) {
                                        if (window.toast) {
                                            window.toast.warning('Вы не можете пригласить самого себя');
                                        } else {
                                            alert('Вы не можете пригласить самого себя');
                                        }
                                        return;
                                    }

                                    const userId = this.dataset.userId;
                                    const userName = this.dataset.userName;
                                    const userPhone = this.dataset.userPhone;

                                    if (!selectedParticipantIds.includes(userId)) {
                                        addParticipant(userId, userName, userPhone);
                                    } else {
                                        if (window.toast) {
                                            window.toast.info('Этот пользователь уже добавлен');
                                        }
                                    }

                                    participantSearch.value = '';
                                    searchResults.style.display = 'none';
                                });
                            });
                        } else {
                            console.log('⚠️ Пользователи не найдены');
                            searchResults.innerHTML = '<div style="padding: 12px; text-align: center; color: #999;">Пользователи не найдены</div>';
                            searchResults.style.display = 'block';
                        }
                    })
                    .catch(error => {
                        console.error('❌ Ошибка поиска:', error);
                        searchResults.innerHTML = '<div style="padding: 12px; text-align: center; color: #dc3545;">Ошибка поиска. Попробуйте еще раз.</div>';
                        searchResults.style.display = 'block';
                    });
            }, 300);
        });
    }

    function addParticipant(userId, userName, userPhone) {
        selectedParticipantIds.push(userId);

        const tag = document.createElement('div');
        tag.className = 'participant-tag';
        tag.innerHTML = `
            <i class="fas fa-user"></i>
            <span>${userName}</span>
            <i class="fas fa-times remove-participant" data-user-id="${userId}"></i>
        `;

        tag.querySelector('.remove-participant').addEventListener('click', function() {
            const id = this.dataset.userId;
            selectedParticipantIds = selectedParticipantIds.filter(pid => pid !== id);
            tag.remove();
            updateInvitedParticipantsInput();
        });

        selectedParticipants.appendChild(tag);
        updateInvitedParticipantsInput();
    }

    function updateInvitedParticipantsInput() {
        invitedParticipantsInput.value = selectedParticipantIds.join(',');
    }

    // Закрытие результатов поиска при клике вне
    document.addEventListener('click', function(e) {
        if (!participantSearch?.contains(e.target) && !searchResults?.contains(e.target)) {
            if (searchResults) searchResults.style.display = 'none';
        }
    });
});
</script>


{% endblock %}

{% block extra_js %}
<script src="{% static 'js/booking.js' %}"></script>

<!-- FullCalendar JS -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>

<script>
// Проверка загрузки FullCalendar
document.addEventListener('DOMContentLoaded', function() {
    if (typeof FullCalendar !== 'undefined') {
        console.log('✅ FullCalendar library loaded successfully!', FullCalendar);
    } else {
        console.error('❌ FullCalendar library NOT loaded!');
    }
});
</script>

<script>
// Инициализация FullCalendar при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    console.log('🎯 Initializing main calendar...');

    // Скрываем индикатор загрузки после загрузки DOM
    const pageLoader = document.getElementById('page-loader');
    if (pageLoader) {
        setTimeout(() => {
            pageLoader.style.opacity = '0';
            pageLoader.style.transition = 'opacity 0.3s ease';
            setTimeout(() => {
                pageLoader.style.display = 'none';
            }, 300);
        }, 500); // Показываем минимум 500мс для плавности
    }

    const calendarEl = document.getElementById('main-calendar');

    if (!calendarEl) {
        console.error('❌ Calendar element #main-calendar NOT found!');
        return;
    }

    console.log('✅ Calendar element found');

    if (!window.FullCalendar) {
        console.error('❌ FullCalendar library not available!');
        return;
    }

    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'ru',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth'
        },
        buttonText: {
            today: 'Сегодня',
            month: 'Месяц'
        },
        height: 480,
        contentHeight: 420,
        aspectRatio: 2,
        nowIndicator: true,
        selectable: false,
        fixedWeekCount: false,
        displayEventTime: false,
        displayEventEnd: false,
        eventDisplay: 'block',

        // Загрузка событий с сервера
        events: function(info, successCallback, failureCallback) {
            fetch(`/booking/api/calendar-events/?start=${info.startStr}&end=${info.endStr}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('📅 Calendar events loaded:', data.length, 'events');

                    // Проверяем что data это массив
                    if (!Array.isArray(data)) {
                        console.error('❌ API returned non-array:', data);
                        successCallback([]);
                        return;
                    }

                    successCallback(data);
                })
                .catch(error => {
                    console.error('❌ Error loading calendar events:', error);
                    failureCallback(error);
                });
        },

        // Клик по событию - показываем детальную информацию
        eventClick: function(info) {
            info.jsEvent.preventDefault();
            showEventDetails(info.event);
        },

        // Клик по дате (выбор даты для бронирования)
        dateClick: function(info) {
            // Проверяем что дата не в прошлом
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const clickedDate = new Date(info.date);
            clickedDate.setHours(0, 0, 0, 0);

            if (clickedDate < today) {
                console.log('⚠️ Cannot select past date');
                if (window.toast) {
                    window.toast.warning('Нельзя выбрать прошедшую дату');
                }
                return;
            }

            console.log('📅 Date selected:', info.dateStr);

            // Убираем выделение со всех дат
            document.querySelectorAll('.fc-day').forEach(day => {
                day.classList.remove('selected-date');
            });

            // Выделяем выбранную дату
            info.dayEl.classList.add('selected-date');

            // ВАЖНО: Обновляем состояние booking.js
            if (window.bookingState) {
                window.bookingState.selectedDate = new Date(info.date);
                console.log('✅ Updated booking state selectedDate:', window.bookingState.selectedDate);
            }

            // Если корт уже выбран - загружаем слоты
            if (window.selectedCourtData && window.selectedCourtData.id) {
                console.log('🎾 Court already selected, loading slots for', info.dateStr);
                if (window.loadTimeSlots && window.formatDate) {
                    const formattedDate = window.formatDate(new Date(info.date));
                    console.log('📡 Loading time slots for court', window.selectedCourtData.id, 'date', formattedDate);
                    window.loadTimeSlots(window.selectedCourtData.id, formattedDate);
                }
            } else {
                // Показываем сообщение что нужно выбрать корт
                if (window.showTimeSlotsMessage) {
                    window.showTimeSlotsMessage('Выберите корт для бронирования');
                }
                console.log('📍 Date selected, waiting for court selection');
            }
        },

        // Настройки внешнего вида
        eventClassNames: function(arg) {
            return ['fc-event-custom'];
        }
    });

    calendar.render();
    console.log('✅ Main calendar rendered!');
    window.mainCalendar = calendar;

    // Автоматически выделяем сегодняшнюю дату при загрузке
    setTimeout(() => {
        const todayEl = document.querySelector('.fc-day-today');
        if (todayEl && window.bookingState) {
            todayEl.classList.add('selected-date');
            window.bookingState.selectedDate = new Date();
            console.log('📅 Auto-selected today:', new Date().toLocaleDateString());
        }
    }, 500);

    // ========== ФУНКЦИЯ ДЛЯ ОТОБРАЖЕНИЯ ДЕТАЛЕЙ СОБЫТИЯ ==========
    function showEventDetails(event) {
        const modal = document.getElementById('eventDetailsModal');
        const props = event.extendedProps;

        // Форматируем дату
        const eventDate = new Date(event.start);
        const formattedDate = eventDate.toLocaleDateString('ru-RU', {
            day: 'numeric',
            month: 'long',
            year: 'numeric'
        });

        // Форматируем время
        const startTime = eventDate.toLocaleTimeString('ru-RU', {
            hour: '2-digit',
            minute: '2-digit'
        });
        const endTime = new Date(event.end).toLocaleTimeString('ru-RU', {
            hour: '2-digit',
            minute: '2-digit'
        });

        // Заполняем данные модального окна
        document.getElementById('event-court-name').textContent = props.courtName || '-';
        document.getElementById('event-date').textContent = formattedDate;
        document.getElementById('event-time').textContent = `${startTime} - ${endTime}`;
        document.getElementById('event-creator').textContent = props.creatorName || '-';
        document.getElementById('event-price').textContent = `${props.price || 0} ₽`;
        document.getElementById('event-players').textContent = `${props.partnersCount + 1} / ${props.maxPlayers}`;

        // Обновляем статус
        const statusBadge = document.getElementById('event-status-badge');
        const statusMap = {
            'confirmed': { text: 'Подтверждено', class: 'status-confirmed' },
            'pending': { text: 'Ожидает', class: 'status-pending' },
            'cancelled': { text: 'Отменено', class: 'status-cancelled' }
        };
        const status = statusMap[props.status] || { text: 'Неизвестно', class: '' };
        statusBadge.textContent = status.text;
        statusBadge.className = 'event-status-badge ' + status.class;

        // Формируем кнопки действий
        const actionsContainer = document.getElementById('event-actions');
        actionsContainer.innerHTML = '';

        if (props.isMine) {
            // Моя бронь - показываем кнопку "Перейти в профиль"
            actionsContainer.innerHTML = `
                <a href="{% url 'profile' %}#bookings" class="btn-primary event-action-btn">
                    <i class="fas fa-user"></i> Перейти в профиль
                </a>
            `;
        } else if (props.canJoin) {
            // Можно присоединиться
            actionsContainer.innerHTML = `
                <button class="btn-primary event-action-btn" onclick="joinBooking(${props.bookingId})">
                    <i class="fas fa-user-plus"></i> Присоединиться к игре
                </button>
            `;
        } else {
            // Просто информация
            actionsContainer.innerHTML = `
                <button class="btn-secondary event-action-btn" onclick="closeEventModal()">
                    <i class="fas fa-times"></i> Закрыть
                </button>
            `;
        }

        // Показываем модальное окно
        modal.style.display = 'flex';
    }

    // Функция закрытия модального окна
    function closeEventModal() {
        const modal = document.getElementById('eventDetailsModal');
        modal.style.display = 'none';
    }

    // Обработчик присоединения к игре
    function joinBooking(bookingId) {
        // TODO: Реализовать присоединение к игре через AJAX
        console.log('Joining booking:', bookingId);
        alert('Функция присоединения к игре будет реализована в следующей версии');
        closeEventModal();
    }

    // ========== ОБРАБОТЧИКИ ЗАКРЫТИЯ МОДАЛЬНЫХ ОКОН ==========

    // Прямой обработчик для кнопки закрытия модального окна событий
    const eventDetailsModal = document.getElementById('eventDetailsModal');
    if (eventDetailsModal) {
        const closeBtn = eventDetailsModal.querySelector('.close-modal');
        if (closeBtn) {
            closeBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('🔴 Закрытие модального окна события');
                eventDetailsModal.style.display = 'none';
            });
        }

        // Закрытие при клике вне модального окна
        eventDetailsModal.addEventListener('click', function(e) {
            if (e.target === eventDetailsModal) {
                console.log('🔴 Клик вне модального окна - закрываем');
                eventDetailsModal.style.display = 'none';
            }
        });
    }

    // Универсальный обработчик для всех модальных окон
    document.addEventListener('click', function(e) {
        // Закрытие по клику на крестик
        if (e.target.classList.contains('close-modal')) {
            const modal = e.target.closest('.modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Закрытие по клику вне модального окна
        if (e.target.classList.contains('modal')) {
            e.target.style.display = 'none';
        }
    });

    // Закрытие по Escape
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (modal.style.display === 'flex' || modal.style.display === 'block') {
                    modal.style.display = 'none';
                }
            });
        }
    });

    // Экспортируем функцию для использования из других мест
    window.closeEventModal = closeEventModal;
});

// ========== ФУНКЦИИ РАБОТЫ С ПРИГЛАШЕНИЯМИ ==========

// Принять приглашение
function acceptInvitation(invitationId) {
    if (!confirm('Вы уверены, что хотите принять это приглашение?')) {
        return;
    }

    // Получаем CSRF token
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch(`/booking/api/invitation/${invitationId}/accept/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Показываем успех
            if (window.toast) {
                window.toast.success(data.message);
            } else {
                alert(data.message);
            }

            // Удаляем карточку приглашения из интерфейса
            const invitationElement = document.getElementById(`invitation-${invitationId}`);
            if (invitationElement) {
                invitationElement.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                invitationElement.style.opacity = '0';
                invitationElement.style.transform = 'scale(0.95)';

                setTimeout(() => {
                    invitationElement.remove();

                    // Проверяем, остались ли приглашения
                    const invitationsList = document.querySelector('.invitations-list');
                    if (invitationsList && invitationsList.children.length === 0) {
                        const invitationsSection = document.querySelector('.invitations-section');
                        if (invitationsSection) {
                            invitationsSection.remove();
                        }
                    }
                }, 300);
            }

            // Обновляем календарь если он есть
            if (window.mainCalendar) {
                window.mainCalendar.refetchEvents();
            }
        } else {
            // Показываем ошибку
            if (window.toast) {
                window.toast.error(data.message);
            } else {
                alert(data.message);
            }
        }
    })
    .catch(error => {
        console.error('Ошибка при принятии приглашения:', error);
        if (window.toast) {
            window.toast.error('Произошла ошибка при принятии приглашения');
        } else {
            alert('Произошла ошибка при принятии приглашения');
        }
    });
}

// Отклонить приглашение
function declineInvitation(invitationId) {
    if (!confirm('Вы уверены, что хотите отклонить это приглашение?')) {
        return;
    }

    // Получаем CSRF token
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch(`/booking/api/invitation/${invitationId}/decline/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Показываем успех
            if (window.toast) {
                window.toast.info(data.message);
            } else {
                alert(data.message);
            }

            // Удаляем карточку приглашения из интерфейса
            const invitationElement = document.getElementById(`invitation-${invitationId}`);
            if (invitationElement) {
                invitationElement.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                invitationElement.style.opacity = '0';
                invitationElement.style.transform = 'scale(0.95)';

                setTimeout(() => {
                    invitationElement.remove();

                    // Проверяем, остались ли приглашения
                    const invitationsList = document.querySelector('.invitations-list');
                    if (invitationsList && invitationsList.children.length === 0) {
                        const invitationsSection = document.querySelector('.invitations-section');
                        if (invitationsSection) {
                            invitationsSection.remove();
                        }
                    }
                }, 300);
            }
        } else {
            // Показываем ошибку
            if (window.toast) {
                window.toast.error(data.message);
            } else {
                alert(data.message);
            }
        }
    })
    .catch(error => {
        console.error('Ошибка при отклонении приглашения:', error);
        if (window.toast) {
            window.toast.error('Произошла ошибка при отклонении приглашения');
        } else {
            alert('Произошла ошибка при отклонении приглашения');
        }
    });
}
</script>
{% endblock %}