{% extends 'base.html' %}
{% load static %}

{% block title %}–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ - Paddle Booking{% endblock %}

{% block extra_css %}
<!-- FullCalendar CSS -->
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css' rel='stylesheet' />
<style>
    /* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –≤–∏–¥–∞ */
    .view-switcher {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-bottom: 20px;
    }

    .view-btn {
        padding: 12px 30px;
        border: 2px solid #e5e7eb;
        background: white;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        font-size: 16px;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .view-btn:hover {
        border-color: #3b82f6;
        background: #eff6ff;
    }

    .view-btn.active {
        border-color: #3b82f6;
        background: #3b82f6;
        color: white;
    }

    /* –ö–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–π –≤–∏–¥ */
    .calendar-view {
        display: none;
    }

    .calendar-view.active {
        display: block;
    }

    .calendar-view .calendar-container {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin: 20px 0;
    }

    .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 15px;
    }

    .calendar-title {
        font-size: 28px;
        font-weight: 700;
        color: #1a1a1a;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .calendar-legend {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
    }

    .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 4px;
    }

    /* Court filter */
    .court-filter {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 20px;
    }

    .court-filter-btn {
        padding: 8px 16px;
        border: 2px solid #e5e7eb;
        background: white;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        font-weight: 500;
    }

    .court-filter-btn:hover {
        border-color: var(--primary-color);
        background: rgba(158, 240, 26, 0.1);
    }

    .court-filter-btn.active {
        border-color: var(--primary-color);
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
        color: white;
    }

    /* –¢–∞–±–ª–∏—á–Ω—ã–π –≤–∏–¥ */
    .table-view.active {
        display: block;
    }

    .table-view:not(.active) {
        display: none;
    }

    /* ========== FullCalendar –õ–ê–ô–ú–û–í–ê–Ø –°–¢–ò–õ–ò–ó–ê–¶–ò–Ø ========== */

    /* –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è */
    #fullcalendar {
        position: relative;
        z-index: 1;
    }

    /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞–ª–µ–Ω–¥–∞—Ä—è */
    #fullcalendar .fc-toolbar {
        background: linear-gradient(135deg, #9ef01a 0%, #bff167 100%) !important;
        padding: 20px !important;
        border-radius: 12px !important;
        margin-bottom: 20px !important;
        box-shadow: 0 4px 15px rgba(158, 240, 26, 0.3) !important;
        position: relative !important;
    }

    #fullcalendar .fc-toolbar-title {
        color: white !important;
        font-weight: 700 !important;
        font-size: 24px !important;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2) !important;
    }

    /* –ö–†–ò–¢–ò–ß–ù–û: –ö–Ω–æ–ø–∫–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–º–∏ */
    #fullcalendar .fc-button {
        background-color: white !important;
        color: #38b000 !important;
        border: 2px solid white !important;
        border-radius: 8px !important;
        font-weight: 600 !important;
        padding: 8px 16px !important;
        transition: all 0.3s ease !important;
        text-transform: capitalize !important;
        cursor: pointer !important;
        outline: none !important;
    }

    #fullcalendar .fc-button:not(:disabled):hover {
        background-color: #bff167 !important;
        color: white !important;
        border-color: #bff167 !important;
        transform: translateY(-2px) !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
    }

    #fullcalendar .fc-button:not(:disabled):active {
        transform: translateY(0) !important;
    }

    #fullcalendar .fc-button-primary.fc-button-active,
    #fullcalendar .fc-button-primary:not(:disabled).fc-button-active {
        background-color: #7cc00f !important;
        color: white !important;
        border-color: #7cc00f !important;
    }

    #fullcalendar .fc-button:disabled {
        opacity: 0.5 !important;
        cursor: not-allowed !important;
    }

    /* –°–µ—Ç–∫–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è */
    .fc .fc-scrollgrid {
        border: 2px solid #f0f0f0 !important;
        border-radius: 12px;
        overflow: hidden;
    }

    .fc .fc-col-header {
        background: linear-gradient(135deg, rgba(158, 240, 26, 0.1) 0%, rgba(191, 241, 103, 0.1) 100%);
    }

    .fc .fc-col-header-cell {
        padding: 12px 0;
        font-weight: 700;
        font-size: 14px;
        color: var(--secondary-color);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .fc .fc-daygrid-day {
        transition: all 0.2s;
    }

    .fc .fc-daygrid-day:hover {
        background: rgba(158, 240, 26, 0.05);
    }

    .fc .fc-daygrid-day-number {
        color: #666;
        font-weight: 600;
        padding: 8px;
        font-size: 14px;
    }

    /* –°–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –¥–µ–Ω—å */
    .fc .fc-day-today {
        background: linear-gradient(135deg, rgba(158, 240, 26, 0.15) 0%, rgba(191, 241, 103, 0.15) 100%) !important;
        border: 2px solid var(--primary-color) !important;
    }

    .fc .fc-day-today .fc-daygrid-day-number {
        color: var(--primary-dark);
        font-weight: 700;
        background: white;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    /* –°–æ–±—ã—Ç–∏—è/–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è */
    .fc-event {
        cursor: pointer;
        border: none !important;
        padding: 6px 10px;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        transition: all 0.2s;
        margin: 2px 0;
    }

    .fc-event:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        opacity: 1 !important;
    }

    /* –¶–≤–µ—Ç–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤ */
    .fc-event.status-confirmed {
        background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%);
        color: white;
    }

    .fc-event.status-pending {
        background: linear-gradient(135deg, #ff9800 0%, #ffb74d 100%);
        color: white;
    }

    .fc-event.status-training {
        background: linear-gradient(135deg, #2196f3 0%, #42a5f5 100%);
        color: white;
    }

    /* –í—ã—Ö–æ–¥–Ω—ã–µ –¥–Ω–∏ */
    .fc .fc-day-sat,
    .fc .fc-day-sun {
        background: rgba(255, 152, 0, 0.03);
    }

    /* –í—Ä–µ–º–µ–Ω–Ω–∞—è —Å–µ—Ç–∫–∞ */
    .fc .fc-timegrid-slot {
        height: 40px;
    }

    .fc .fc-timegrid-slot-label {
        color: #666;
        font-weight: 600;
        font-size: 13px;
    }

    .fc .fc-timegrid-now-indicator-line {
        border-color: var(--primary-color);
        border-width: 2px;
    }

    .fc .fc-timegrid-now-indicator-arrow {
        border-color: var(--primary-color);
    }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
    @media (max-width: 768px) {
        .fc .fc-toolbar {
            flex-direction: column;
            gap: 10px;
            padding: 15px;
        }

        .fc .fc-toolbar-title {
            font-size: 20px;
        }

        .fc .fc-button {
            font-size: 13px !important;
            padding: 6px 12px !important;
        }
    }

    /* ========== –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –°–û–ë–´–¢–ò–Ø ========== */
    .event-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(8px);
        z-index: 9999;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease;
    }

    .event-modal.active {
        display: flex;
    }

    .event-modal-content {
        background: white;
        padding: 0;
        border-radius: 16px;
        max-width: 550px;
        width: 90%;
        max-height: 85vh;
        overflow: hidden;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: slideInUp 0.4s ease;
    }

    .event-modal-header {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
        padding: 25px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 3px solid var(--primary-dark);
    }

    .event-modal-header h3 {
        margin: 0;
        color: white;
        font-size: 22px;
        font-weight: 700;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .event-modal-close {
        background: white;
        color: var(--primary-dark);
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        cursor: pointer;
        transition: all 0.3s;
        border: none;
        font-weight: 700;
    }

    .event-modal-close:hover {
        transform: rotate(90deg) scale(1.1);
        background: var(--primary-dark);
        color: white;
    }

    #modalBody {
        padding: 30px;
        overflow-y: auto;
        max-height: calc(85vh - 100px);
    }

    .event-detail {
        display: flex;
        justify-content: space-between;
        padding: 15px 0;
        border-bottom: 1px solid #f0f0f0;
    }

    .event-detail:last-child {
        border-bottom: none;
    }

    .event-detail-label {
        font-weight: 600;
        color: #666;
        font-size: 14px;
    }

    .event-detail-value {
        font-weight: 700;
        color: #333;
        text-align: right;
        font-size: 15px;
    }

    .event-actions {
        margin-top: 20px;
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }

    .btn-event {
        padding: 12px 24px;
        border-radius: 8px;
        border: none;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 14px;
    }

    .btn-view {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        color: white;
    }

    .btn-view:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(108, 117, 125, 0.3);
    }

    .btn-join {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
        color: white;
    }

    .btn-join:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(158, 240, 26, 0.4);
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(50px) scale(0.9);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
    :root[data-theme="dark"] .event-modal-content {
        background: var(--card-bg);
    }

    :root[data-theme="dark"] #modalBody {
        background: var(--card-bg);
    }

    :root[data-theme="dark"] .event-detail {
        border-bottom-color: var(--card-border);
    }

    :root[data-theme="dark"] .event-detail-label {
        color: var(--gray-color);
    }

    :root[data-theme="dark"] .event-detail-value {
        color: var(--text-color);
    }

    .event-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .event-modal-close {
        cursor: pointer;
        font-size: 24px;
        color: #6b7280;
    }

    .event-modal-close:hover {
        color: #1a1a1a;
    }

    .event-detail {
        margin-bottom: 15px;
    }

    .event-detail-label {
        font-weight: 600;
        color: #6b7280;
        font-size: 12px;
        text-transform: uppercase;
        margin-bottom: 4px;
    }

    .event-detail-value {
        font-size: 16px;
        color: #1a1a1a;
    }

    .event-actions {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }

    .btn-event {
        flex: 1;
        padding: 12px;
        border-radius: 8px;
        border: none;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-view {
        background: #3b82f6;
        color: white;
    }

    .btn-view:hover {
        background: #2563eb;
    }

    .btn-join {
        background: #10b981;
        color: white;
    }

    .btn-join:hover {
        background: #059669;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è —Ç–∏–ø–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è */
    .type-option .type-card {
        text-align: center;
        padding: 20px 15px;
        border: 3px solid #e5e7eb;
        border-radius: 12px;
        background: white;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .type-option:hover .type-card {
        border-color: var(--primary-color);
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(158, 240, 26, 0.2);
    }

    .type-option.active .type-card {
        border-color: var(--primary-color);
        background: linear-gradient(135deg, rgba(158, 240, 26, 0.1) 0%, rgba(191, 241, 103, 0.1) 100%);
        box-shadow: 0 8px 20px rgba(158, 240, 26, 0.25);
        transform: scale(1.02);
    }

    .type-option .type-card i {
        color: var(--secondary-color);
        transition: all 0.3s;
    }

    .type-option.active .type-card i {
        color: var(--primary-color);
        transform: scale(1.1);
    }

    #coach-selection {
        animation: slideDown 0.4s ease-out;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            max-height: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            max-height: 200px;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ—Ä—Ç–æ–≤</h1>
    <p>–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É, –∫–æ—Ä—Ç –∏ –≤—Ä–µ–º—è –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</p>
</div>

<!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –≤–∏–¥–∞ -->
<div class="view-switcher">
    <button class="view-btn active" onclick="switchView('table')">
        <i class="fas fa-list"></i> –¢–∞–±–ª–∏—á–Ω—ã–π –≤–∏–¥
    </button>
    <button class="view-btn" onclick="switchView('calendar')">
        <i class="fas fa-calendar"></i> –ö–∞–ª–µ–Ω–¥–∞—Ä—å
    </button>
</div>

<!-- –¢–∞–±–ª–∏—á–Ω—ã–π –≤–∏–¥ (–∏—Å—Ö–æ–¥–Ω—ã–π) -->
<div class="table-view active" id="tableView">

<!-- –ì–û–†–ò–ó–û–ù–¢–ê–õ–¨–ù–´–ô –ö–ê–õ–ï–ù–î–ê–†–¨ -->
<div class="calendar-container">
    <div class="month-header" style="
        text-align: center;
        margin-bottom: 15px;
        font-weight: 700;
        color: #333;
        font-size: 24px;
        padding: 10px 0;
        background: linear-gradient(135deg, rgba(158, 240, 26, 0.1) 0%, rgba(191, 241, 103, 0.1) 100%);
        border-radius: 10px;
        border: 2px solid rgba(158, 240, 26, 0.2);
        width: 100%;
    ">
        –î–µ–∫–∞–±—Ä—å
    </div>

    <div class="week-controls" style="
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        margin-bottom: 10px;
        width: 100%;
    ">
        <button id="prev-week" class="week-arrow" type="button" title="–ü—Ä–µ–¥—ã–¥—É—â–∞—è –Ω–µ–¥–µ–ª—è">
            <i class="fas fa-chevron-left"></i>
        </button>

        <div class="week-nav" id="week-nav" style="
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 5px;
            flex: 1;
            max-width: 800px;
            padding: 0;
            height: 90px;
            margin: 0 10px;
        ">
            <!-- JavaScript –∑–∞–ø–æ–ª–Ω–∏—Ç –¥–Ω–∏ –∑–¥–µ—Å—å -->
        </div>

        <button id="next-week" class="week-arrow" type="button" title="–°–ª–µ–¥—É—é—â–∞—è –Ω–µ–¥–µ–ª—è">
            <i class="fas fa-chevron-right"></i>
        </button>
    </div>
</div>

<!-- –ì–û–†–ò–ó–û–ù–¢–ê–õ–¨–ù–´–ô –í–´–ë–û–† –ö–û–†–¢–û–í -->
<div class="courts-horizontal-container">
    <div class="section-card">
        <h3><i class="fas fa-court-sport"></i> –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ—Ä—Ç</h3>

        <div id="courts-horizontal-list" class="courts-horizontal-list">
            {% for court in courts %}
            <div class="court-horizontal-item {% if forloop.first %}active{% endif %}"
                 data-court-id="{{ court.id }}"
                 data-court-price="{{ court.price_per_hour }}"
                 onclick="selectCourt(this, {{ court.id }}, {{ court.price_per_hour }})"
                 style="cursor: pointer;">

                <div class="court-horizontal-image">
                    <i class="fas fa-tennis-ball"></i>
                </div>
                <div class="court-horizontal-info">
                    <h4>{{ court.name }}</h4>
                    <span class="court-price">{{ court.price_per_hour }} ‚ÇΩ/—á–∞—Å</span>
                    <p class="court-description">{{ court.description|truncatechars:60 }}</p>
                    <div class="court-status">
                        {% if court.is_available %}
                        <span class="status-available"><i class="fas fa-check-circle"></i> –î–æ—Å—Ç—É–ø–µ–Ω</span>
                        {% else %}
                        <span class="status-unavailable"><i class="fas fa-times-circle"></i> –ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="no-courts">
                <i class="fas fa-tennis-ball"></i>
                <p>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ—Ä—Ç–æ–≤ –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç</p>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- –í–†–ï–ú–ï–ù–ù–´–ï –°–õ–û–¢–´ –° –†–ê–ó–î–ï–õ–ê–ú–ò -->
<div class="time-slots-container">
    <div class="section-card">
        <h3><i class="fas fa-clock"></i> –î–æ—Å—Ç—É–ø–Ω–æ–µ –≤—Ä–µ–º—è</h3>

        <div id="time-slots-sections" class="time-slots-sections">
            <!-- –£–¢–†–û -->
            <div class="time-section morning-section">
                <div class="section-header" data-section="morning">
                    <h4><i class="fas fa-sun"></i> –£—Ç—Ä–æ (8:00 - 12:00)</h4>
                    <span class="toggle-arrow"><i class="fas fa-chevron-down"></i></span>
                </div>
                <div class="section-content" id="morning-slots" style="display: block;">
                    <div class="select-court-date">
                        <i class="fas fa-calendar-check"></i>
                        <p>–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –∫–æ—Ä—Ç, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ–µ –≤—Ä–µ–º—è</p>
                    </div>
                </div>
            </div>

            <!-- –î–ï–ù–¨ -->
            <div class="time-section day-section">
                <div class="section-header" data-section="day">
                    <h4><i class="fas fa-cloud-sun"></i> –î–µ–Ω—å (12:00 - 17:00)</h4>
                    <span class="toggle-arrow"><i class="fas fa-chevron-down"></i></span>
                </div>
                <div class="section-content" id="day-slots" style="display: block;">
                    <div class="select-court-date">
                        <i class="fas fa-calendar-check"></i>
                        <p>–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –∫–æ—Ä—Ç, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ–µ –≤—Ä–µ–º—è</p>
                    </div>
                </div>
            </div>

            <!-- –í–ï–ß–ï–† -->
            <div class="time-section evening-section">
                <div class="section-header" data-section="evening">
                    <h4><i class="fas fa-moon"></i> –í–µ—á–µ—Ä (17:00 - 22:00)</h4>
                    <span class="toggle-arrow"><i class="fas fa-chevron-down"></i></span>
                </div>
                <div class="section-content" id="evening-slots" style="display: block;">
                    <div class="select-court-date">
                        <i class="fas fa-calendar-check"></i>
                        <p>–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –∫–æ—Ä—Ç, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ–µ –≤—Ä–µ–º—è</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –°–¢–ê–¢–ò–°–¢–ò–ö–ê –í–´–ë–†–ê–ù–ù–û–ì–û –í–†–ï–ú–ï–ù–ò -->
<div id="selected-time-info" class="selected-time-info" style="display: none;">
    <div class="section-card">
        <h3><i class="fas fa-check-circle"></i> –í—ã–±—Ä–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è</h3>
        <div class="selected-details">
            <div class="selected-item">
                <span class="label">–ö–æ—Ä—Ç:</span>
                <span id="selected-court" class="value"></span>
            </div>
            <div class="selected-item">
                <span class="label">–î–∞—Ç–∞:</span>
                <span id="selected-date" class="value"></span>
            </div>
            <div class="selected-item">
                <span class="label">–í—Ä–µ–º—è:</span>
                <span id="selected-time" class="value"></span>
            </div>
            <div class="selected-item">
                <span class="label">–°—Ç–æ–∏–º–æ—Å—Ç—å:</span>
                <span id="selected-price" class="value"></span>
            </div>
            <button id="confirm-booking-btn" class="btn-primary">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
<div id="bookingConfirmModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close-modal">&times;</span>
        <h2>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h2>
        <div class="booking-details">
            <div class="booking-detail-item">
                <span class="detail-label">–ö–æ—Ä—Ç:</span>
                <span id="modal-court-name" class="detail-value"></span>
            </div>
            <div class="booking-detail-item">
                <span class="detail-label">–î–∞—Ç–∞:</span>
                <span id="modal-date" class="detail-value"></span>
            </div>
            <div class="booking-detail-item">
                <span class="detail-label">–í—Ä–µ–º—è:</span>
                <span id="modal-time" class="detail-value"></span>
            </div>
            <div class="booking-detail-item">
                <span class="detail-label">–°—Ç–æ–∏–º–æ—Å—Ç—å:</span>
                <span id="modal-price" class="detail-value"></span>
            </div>
        </div>

        <form id="booking-form" method="post" action="{% url 'create_booking' %}">
            {% csrf_token %}
            <input type="hidden" name="court_id" id="form-court-id">
            <input type="hidden" name="date" id="form-date">
            <input type="hidden" name="start_time" id="form-start-time">
            <input type="hidden" name="end_time" id="form-end-time">
            <input type="hidden" name="duration" id="form-duration" value="1">

            <!-- –¢–∏–ø –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
            <div class="booking-type-selector" style="margin: 20px 0;">
                <label style="display: block; margin-bottom: 12px; font-weight: 600; color: var(--secondary-color); font-size: 15px;">
                    <i class="fas fa-clipboard-list"></i> –¢–∏–ø –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:
                </label>
                <div style="display: flex; gap: 12px;">
                    <label class="type-option active" style="flex: 1; cursor: pointer;">
                        <input type="radio" name="booking_type" value="game" checked style="display: none;">
                        <div class="type-card">
                            <i class="fas fa-users" style="font-size: 24px; margin-bottom: 8px;"></i>
                            <span style="font-weight: 600; font-size: 15px;">–ò–≥—Ä–∞</span>
                            <small style="display: block; font-size: 12px; color: #666; margin-top: 4px;">–ò–≥—Ä–∞—Ç—å —Å –¥—Ä—É–∑—å—è–º–∏</small>
                        </div>
                    </label>
                    <label class="type-option" style="flex: 1; cursor: pointer;">
                        <input type="radio" name="booking_type" value="training" style="display: none;">
                        <div class="type-card">
                            <i class="fas fa-dumbbell" style="font-size: 24px; margin-bottom: 8px;"></i>
                            <span style="font-weight: 600; font-size: 15px;">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</span>
                            <small style="display: block; font-size: 12px; color: #666; margin-top: 4px;">–° —Ç—Ä–µ–Ω–µ—Ä–æ–º</small>
                        </div>
                    </label>
                </div>
            </div>

            <!-- –ò—â—É –ø–∞—Ä—Ç–Ω–µ—Ä–∞ (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –∏–≥—Ä) -->
            <div id="partner-search-section" style="margin: 20px 0; padding: 15px; background: linear-gradient(135deg, #f0f8ff 0%, #e6f2ff 100%); border-radius: 12px; border: 2px solid #b3d9ff;">
                <label style="display: flex; align-items: center; cursor: pointer; user-select: none;">
                    <input type="checkbox" name="looking_for_partner" id="looking-for-partner" value="1" style="
                        width: 20px;
                        height: 20px;
                        margin-right: 12px;
                        cursor: pointer;
                        accent-color: var(--primary-color);
                    ">
                    <div style="flex: 1;">
                        <span style="font-weight: 600; color: var(--secondary-color); font-size: 15px;">
                            <i class="fas fa-user-plus"></i> –ò—â—É –ø–∞—Ä—Ç–Ω–µ—Ä–∞ –¥–ª—è –∏–≥—Ä—ã
                        </span>
                        <small style="display: block; font-size: 12px; color: #666; margin-top: 4px;">
                            –í–∞—à–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –±—É–¥–µ—Ç –≤–∏–¥–Ω–æ –¥—Ä—É–≥–∏–º –∏–≥—Ä–æ–∫–∞–º, –∫–æ—Ç–æ—Ä—ã–µ –∏—â—É—Ç –ø–∞—Ä—Ç–Ω–µ—Ä–∞
                        </small>
                    </div>
                </label>
            </div>

            <!-- –í—ã–±–æ—Ä —Ç—Ä–µ–Ω–µ—Ä–∞ (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫) -->
            <div id="coach-selection" style="display: none; margin: 20px 0; padding: 15px; background: linear-gradient(135deg, #fff8f0 0%, #fff5e6 100%); border-radius: 12px; border: 2px solid #ffe0b3;">
                <label style="display: block; margin-bottom: 12px; font-weight: 600; color: var(--secondary-color); font-size: 15px;">
                    <i class="fas fa-user-tie"></i> –í—ã–±–µ—Ä–∏—Ç–µ —Ç—Ä–µ–Ω–µ—Ä–∞:
                </label>
                <select name="coach" id="coach-select" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; background: white;">
                    <option value="">–ë–µ–∑ —Ç—Ä–µ–Ω–µ—Ä–∞</option>
                    {% comment %}
                    <!-- –¢—Ä–µ–Ω–µ—Ä—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ AJAX -->
                    {% endcomment %}
                </select>
                <small style="display: block; margin-top: 8px; color: #666; font-size: 13px;">
                    <i class="fas fa-info-circle"></i> –í—ã–±–æ—Ä —Ç—Ä–µ–Ω–µ—Ä–∞ –∏–∑–º–µ–Ω–∏—Ç —Å—Ç–æ–∏–º–æ—Å—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                </small>
            </div>

            <div class="form-actions">
                <button type="button" class="btn-secondary cancel-booking">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="btn-primary confirm-booking">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
            </div>
        </form>
    </div>
</div>

<style>
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è */
    .calendar-container {
        margin-bottom: 30px;
    }

    /* –ì–û–†–ò–ó–û–ù–¢–ê–õ–¨–ù–´–ô –í–´–ë–û–† –ö–û–†–¢–û–í */
    .courts-horizontal-container {
        margin-bottom: 30px;
    }

    .courts-horizontal-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .court-horizontal-item {
        background: white;
        border-radius: 15px;
        padding: 25px;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 3px solid #eee;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
    }

    .court-horizontal-item:hover {
        transform: translateY(-8px);
        box-shadow: 0 15px 30px rgba(158, 240, 26, 0.15);
        border-color: #bff167;
    }

    .court-horizontal-item.active {
        border-color: #9ef01a;
        background: linear-gradient(135deg, rgba(158, 240, 26, 0.05) 0%, rgba(191, 241, 103, 0.05) 100%);
        box-shadow: 0 15px 35px rgba(158, 240, 26, 0.2);
    }

    .court-horizontal-image {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: linear-gradient(135deg, #9ef01a 0%, #bff167 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 20px;
    }

    .court-horizontal-image i {
        font-size: 40px;
        color: white;
    }

    .court-horizontal-info h4 {
        margin: 0 0 10px 0;
        color: #333;
        font-size: 20px;
        font-weight: 700;
    }

    .court-price {
        display: inline-block;
        background: linear-gradient(135deg, #9ef01a 0%, #bff167 100%);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 700;
        font-size: 16px;
        margin-bottom: 15px;
        box-shadow: 0 3px 8px rgba(158, 240, 26, 0.3);
    }

    .court-description {
        color: #666;
        font-size: 14px;
        line-height: 1.5;
        margin-bottom: 15px;
        min-height: 40px;
    }

    .court-status {
        font-size: 14px;
        font-weight: 600;
    }

    .status-available {
        color: #38b000;
    }

    .status-unavailable {
        color: #dc3545;
    }

    /* –í–†–ï–ú–ï–ù–ù–´–ï –°–õ–û–¢–´ –° –†–ê–ó–î–ï–õ–ê–ú–ò */
    .time-slots-container {
        margin-bottom: 30px;
    }

    .time-slots-sections {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .time-section {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        border: 2px solid #f0f0f0;
        transition: all 0.3s ease;
    }

    .time-section.morning-section .section-header {
        background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
    }

    .time-section.day-section .section-header {
        background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
    }

    .time-section.evening-section .section-header {
        background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%);
    }

    .section-header {
        padding: 20px 25px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: white;
        user-select: none;
    }

    .section-header h4 {
        margin: 0;
        font-size: 18px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .section-header h4 i {
        font-size: 20px;
    }

    .toggle-arrow {
        transition: transform 0.3s ease;
    }

    .section-content {
        padding: 25px;
        animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* –°–ï–¢–ö–ê –í–†–ï–ú–ï–ù–ù–´–• –°–õ–û–¢–û–í */
    .time-slots-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 15px;
    }

    .time-slot-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 3px solid #eee;
        text-align: center;
        position: relative;
    }

    .time-slot-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }

    .time-slot-card.available {
        border-color: #bff167;
    }

    .time-slot-card.available:hover {
        background: linear-gradient(135deg, #9ef01a 0%, #bff167 100%);
        border-color: #9ef01a;
    }

    .time-slot-card.available:hover .slot-time,
    .time-slot-card.available:hover .slot-price {
        color: white;
    }

    .time-slot-card.unavailable {
        opacity: 0.5;
        cursor: not-allowed;
        background: #f8f8f8;
    }

    .slot-time {
        display: block;
        font-weight: 700;
        color: #333;
        font-size: 18px;
        margin-bottom: 8px;
    }

    .slot-price {
        display: block;
        font-size: 16px;
        color: #38b000;
        font-weight: 600;
        margin-bottom: 5px;
    }

    .slot-status {
        font-size: 12px;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .time-slot-card.available .slot-status {
        color: #38b000;
    }

    .time-slot-card.unavailable .slot-status {
        color: #dc3545;
    }

    /* –°–¢–ê–¢–ò–°–¢–ò–ö–ê –í–´–ë–†–ê–ù–ù–û–ì–û –í–†–ï–ú–ï–ù–ò */
    .selected-time-info {
        margin-top: 30px;
        animation: slideUp 0.5s ease;
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .selected-details {
        background: linear-gradient(135deg, #f8fff8 0%, #f0fff0 100%);
        border-radius: 12px;
        padding: 25px;
        border: 2px solid #bff167;
    }

    .selected-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 0;
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }

    .selected-item:last-child {
        border-bottom: none;
        padding-top: 20px;
        margin-top: 10px;
    }

    .selected-item .label {
        font-weight: 600;
        color: #555;
        font-size: 16px;
    }

    .selected-item .value {
        font-weight: 700;
        color: #333;
        font-size: 18px;
    }

    #confirm-booking-btn {
        width: 100%;
        margin-top: 10px;
        padding: 15px;
        font-size: 18px;
        font-weight: 700;
    }

    /* –°–û–û–ë–©–ï–ù–ò–Ø */
    .select-court-date {
        text-align: center;
        padding: 40px 20px;
        color: #888;
        grid-column: 1 / -1;
    }

    .select-court-date i {
        font-size: 48px;
        margin-bottom: 15px;
        color: #ccc;
    }

    .select-court-date p {
        margin: 0;
        font-size: 16px;
    }

    .loading {
        text-align: center;
        padding: 30px;
        color: #666;
        grid-column: 1 / -1;
    }

    .loading i {
        margin-right: 10px;
    }

    .error-message {
        text-align: center;
        padding: 30px;
        color: #dc3545;
        grid-column: 1 / -1;
    }

    .error-message i {
        margin-right: 10px;
    }

    /* –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ */
    @media (max-width: 1200px) {
        .courts-horizontal-list {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 768px) {
        .courts-horizontal-list {
            grid-template-columns: 1fr;
        }

        .time-slots-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .section-header {
            padding: 15px 20px;
        }

        .section-header h4 {
            font-size: 16px;
        }

        .time-slot-card {
            padding: 15px;
        }

        .slot-time {
            font-size: 16px;
        }
    }

    @media (max-width: 480px) {
        .time-slots-grid {
            grid-template-columns: 1fr;
        }

        .court-horizontal-item {
            padding: 20px;
        }

        .selected-item {
            flex-direction: column;
            align-items: flex-start;
            gap: 5px;
        }

        .selected-item .value {
            font-size: 16px;
        }
    }
</style>

<script>
// –ü—Ä–æ—Å—Ç–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ—Å—Ç–∏
function selectCourt(element, courtId, courtPrice) {
    console.log('–ö–æ—Ä—Ç –∫–ª–∏–∫–Ω—É—Ç!', courtId, courtPrice);

    // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö –∫–æ—Ä—Ç–æ–≤
    document.querySelectorAll('.court-horizontal-item').forEach(item => {
        item.classList.remove('active');
        item.style.borderColor = '#eee';
        item.style.boxShadow = '0 5px 15px rgba(0, 0, 0, 0.08)';
    });

    // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É
    element.classList.add('active');
    element.style.borderColor = '#9ef01a';
    element.style.boxShadow = '0 15px 35px rgba(158, 240, 26, 0.2)';

    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∫–æ—Ä—Ç –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
    if (window.selectedCourtData) {
        window.selectedCourtData = {
            id: courtId,
            price: courtPrice,
            name: element.querySelector('h4').textContent
        };
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ª–æ—Ç—ã –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∫–æ—Ä—Ç–∞
    if (window.selectedDate && window.loadTimeSlots) {
        const dateStr = window.formatDate ? window.formatDate(window.selectedDate) : new Date().toISOString().split('T')[0];
        window.loadTimeSlots(courtId, dateStr);
    }
}
</script>

<!-- –ü–†–û–°–¢–û–ô –ò –ù–ê–î–ï–ñ–ù–´–ô –°–ö–†–ò–ü–¢ –î–õ–Ø –°–ï–ö–¶–ò–ô -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('üéØ Section handler loaded');

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–ª–∏–∫–æ–≤ –Ω–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö
    function setupSectionHandlers() {
        const sections = ['morning', 'day', 'evening'];

        sections.forEach(section => {
            const header = document.querySelector(`[data-section="${section}"]`);
            const content = document.getElementById(`${section}-slots`);

            if (!header || !content) {
                console.log(`‚ùå Section ${section} not found`);
                return;
            }

            // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
            const newHeader = header.cloneNode(true);
            header.parentNode.replaceChild(newHeader, header);

            const newContent = content.cloneNode(true);
            content.parentNode.replaceChild(newContent, content);

            // –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
            const currentHeader = document.querySelector(`[data-section="${section}"]`);
            const currentContent = document.getElementById(`${section}-slots`);

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞
            currentHeader.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log(`üéØ Clicked ${section} section`);

                if (currentContent.style.display === 'none') {
                    currentContent.style.display = 'block';
                    const arrow = this.querySelector('.toggle-arrow i');
                    if (arrow) arrow.className = 'fas fa-chevron-down';
                    console.log(`‚úÖ ${section} opened`);
                } else {
                    currentContent.style.display = 'none';
                    const arrow = this.querySelector('.toggle-arrow i');
                    if (arrow) arrow.className = 'fas fa-chevron-right';
                    console.log(`‚úÖ ${section} closed`);
                }
            });

            currentHeader.style.cursor = 'pointer';
        });

        console.log('‚úÖ All sections initialized');
    }

    // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    setTimeout(setupSectionHandlers, 100);

    // ========== –£–ü–†–ê–í–õ–ï–ù–ò–ï –¢–ò–ü–û–ú –ë–†–û–ù–ò–†–û–í–ê–ù–ò–Ø ==========
    const typeOptions = document.querySelectorAll('.type-option');
    const coachSelection = document.getElementById('coach-selection');
    const partnerSearchSection = document.getElementById('partner-search-section');
    const coachSelect = document.getElementById('coach-select');

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É —Ç–∏–ø–∞–º–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    typeOptions.forEach(option => {
        option.addEventListener('click', function() {
            // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö –æ–ø—Ü–∏–π
            typeOptions.forEach(opt => opt.classList.remove('active'));

            // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –æ–ø—Ü–∏–∏
            this.classList.add('active');

            // –û—Ç–º–µ—á–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π radio button
            const radio = this.querySelector('input[type="radio"]');
            if (radio) {
                radio.checked = true;

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
                if (radio.value === 'training') {
                    // –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä —Ç—Ä–µ–Ω–µ—Ä–∞, —Å–∫—Ä—ã–≤–∞–µ–º –ø–æ–∏—Å–∫ –ø–∞—Ä—Ç–Ω–µ—Ä–∞
                    if (coachSelection) coachSelection.style.display = 'block';
                    if (partnerSearchSection) partnerSearchSection.style.display = 'none';

                    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ç—Ä–µ–Ω–µ—Ä–æ–≤
                    loadCoaches();
                } else {
                    // –ò–≥—Ä–∞: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–∏—Å–∫ –ø–∞—Ä—Ç–Ω–µ—Ä–∞, —Å–∫—Ä—ã–≤–∞–µ–º –≤—ã–±–æ—Ä —Ç—Ä–µ–Ω–µ—Ä–∞
                    if (coachSelection) coachSelection.style.display = 'none';
                    if (partnerSearchSection) partnerSearchSection.style.display = 'block';
                    if (coachSelect) coachSelect.value = '';
                }
            }
        });
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Ç—Ä–µ–Ω–µ—Ä–æ–≤
    function loadCoaches() {
        fetch('/booking/api/coaches/')
            .then(response => response.json())
            .then(data => {
                const select = document.getElementById('coach-select');
                if (!select) return;

                // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ–ø—Ü–∏–∏ (–∫—Ä–æ–º–µ "–ë–µ–∑ —Ç—Ä–µ–Ω–µ—Ä–∞")
                select.innerHTML = '<option value="">–ë–µ–∑ —Ç—Ä–µ–Ω–µ—Ä–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</option>';

                // –î–æ–±–∞–≤–ª—è–µ–º —Ç—Ä–µ–Ω–µ—Ä–æ–≤
                data.coaches.forEach(coach => {
                    const option = document.createElement('option');
                    option.value = coach.id;
                    option.textContent = `${coach.name} (‚≠ê ${coach.rating}) - ${coach.hourly_rate}‚ÇΩ/—á–∞—Å`;
                    option.dataset.rate = coach.hourly_rate;
                    select.appendChild(option);
                });
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—Ä–µ–Ω–µ—Ä–æ–≤:', error);
            });
    }
});
</script>

</div> <!-- –ó–∞–∫—Ä—ã–≤–∞–µ–º table-view -->

<!-- –ö–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–π –≤–∏–¥ -->
<div class="calendar-view" id="calendarView">
    <div class="calendar-container">
        <div class="calendar-header">
            <div class="calendar-title">
                <span>üìÖ</span>
                –ö–∞–ª–µ–Ω–¥–∞—Ä—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π
            </div>
            <div class="calendar-legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #10b981;"></div>
                    <span>–ú–æ—ë –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #f59e0b;"></div>
                    <span>–ú–æ—ë –æ–∂–∏–¥–∞–µ—Ç</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #3b82f6;"></div>
                    <span>–ó–∞–Ω—è—Ç–æ</span>
                </div>
            </div>
        </div>

        <!-- –§–∏–ª—å—Ç—Ä –ø–æ –∫–æ—Ä—Ç–∞–º -->
        <div class="court-filter">
            <button class="court-filter-btn active" data-court-id="all">–í—Å–µ –∫–æ—Ä—Ç—ã</button>
            {% for court in courts %}
            <button class="court-filter-btn" data-court-id="{{ court.id }}">{{ court.name }}</button>
            {% endfor %}
        </div>

        <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å -->
        <div id="fullcalendar"></div>
    </div>
</div>

<!-- Modal –¥–ª—è –¥–µ—Ç–∞–ª–µ–π —Å–æ–±—ã—Ç–∏—è -->
<div class="event-modal" id="eventModal">
    <div class="event-modal-content">
        <div class="event-modal-header">
            <h3 id="modalTitle">–î–µ—Ç–∞–ª–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
            <span class="event-modal-close" onclick="closeEventModal()">&times;</span>
        </div>
        <div id="modalBody"></div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/booking.js' %}"></script>

<!-- FullCalendar JS -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>

<script>
// –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ FullCalendar
document.addEventListener('DOMContentLoaded', function() {
    if (typeof FullCalendar !== 'undefined') {
        console.log('‚úÖ FullCalendar library loaded successfully!', FullCalendar);
    } else {
        console.error('‚ùå FullCalendar library NOT loaded!');
    }
});
</script>

<script>
// –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –≤–∏–¥–∞
function switchView(view) {
    console.log('üîÑ Switching to view:', view);
    const tableView = document.getElementById('tableView');
    const calendarView = document.getElementById('calendarView');
    const buttons = document.querySelectorAll('.view-btn');

    buttons.forEach(btn => btn.classList.remove('active'));

    if (view === 'table') {
        console.log('üìã Activating table view');
        tableView.classList.add('active');
        calendarView.classList.remove('active');
        buttons[0].classList.add('active');
    } else {
        console.log('üìÖ Activating calendar view');
        tableView.classList.remove('active');
        calendarView.classList.add('active');
        buttons[1].classList.add('active');

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏
        if (!window.calendarInitialized) {
            console.log('üÜï First time opening calendar, initializing...');

            // –í–ê–ñ–ù–û: –î–∞–µ–º –±—Ä–∞—É–∑–µ—Ä—É –≤—Ä–µ–º—è –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å DOM —ç–ª–µ–º–µ–Ω—Ç
            setTimeout(() => {
                console.log('‚è∞ Starting calendar initialization after timeout...');
                try {
                    initFullCalendar();
                    window.calendarInitialized = true;
                } catch (error) {
                    console.error('‚ùå Error initializing calendar:', error);
                    console.error('Stack trace:', error.stack);
                }
            }, 100);
        } else {
            console.log('‚ôªÔ∏è Calendar already initialized');
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä –∫–∞–ª–µ–Ω–¥–∞—Ä—è
            if (window.fullCalendar) {
                window.fullCalendar.updateSize();
            }
        }
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è FullCalendar
function initFullCalendar() {
    console.log('üéØ Initializing FullCalendar...');
    console.log('üîç Looking for element with ID: fullcalendar');

    const calendarEl = document.getElementById('fullcalendar');
    console.log('üîé Search result:', calendarEl);

    if (!calendarEl) {
        console.error('‚ùå Calendar element #fullcalendar NOT found!');
        console.error('Available elements in calendarView:', document.getElementById('calendarView'));
        return;
    }

    console.log('‚úÖ Calendar element found:', calendarEl);
    console.log('üìè Element dimensions:', {
        width: calendarEl.offsetWidth,
        height: calendarEl.offsetHeight,
        display: window.getComputedStyle(calendarEl).display
    });

    if (!window.FullCalendar) {
        console.error('‚ùå FullCalendar library not available!');
        return;
    }
    console.log('‚úÖ FullCalendar library is available');

    let selectedCourtId = 'all';

    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'ru',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        buttonText: {
            today: '–°–µ–≥–æ–¥–Ω—è',
            month: '–ú–µ—Å—è—Ü',
            week: '–ù–µ–¥–µ–ª—è',
            day: '–î–µ–Ω—å'
        },
        height: 'auto',
        slotMinTime: '08:00:00',
        slotMaxTime: '22:00:00',
        allDaySlot: false,
        nowIndicator: true,
        selectable: true,

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π —Å —Å–µ—Ä–≤–µ—Ä–∞
        events: function(info, successCallback, failureCallback) {
            console.log('üì° Fetching calendar events from:', info.startStr, 'to:', info.endStr);

            fetch(`/booking/api/calendar-events/?start=${info.startStr}&end=${info.endStr}`)
                .then(response => {
                    console.log('üì° Response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('üìÖ Calendar events loaded:', data);

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ data —ç—Ç–æ –º–∞—Å—Å–∏–≤, –∞ –Ω–µ –æ–±—ä–µ–∫—Ç —Å –æ—à–∏–±–∫–æ–π
                    if (!Array.isArray(data)) {
                        console.error('‚ùå API returned non-array:', data);
                        if (data.success === false) {
                            console.error('API error message:', data.message);
                        }
                        successCallback([]);
                        return;
                    }

                    // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –∫–æ—Ä—Ç—É
                    let filteredEvents = data;
                    if (selectedCourtId !== 'all') {
                        filteredEvents = data.filter(event =>
                            event.extendedProps && event.extendedProps.courtId == selectedCourtId
                        );
                        console.log(`üîç Filtered events for court ${selectedCourtId}:`, filteredEvents.length);
                    }

                    successCallback(filteredEvents);
                })
                .catch(error => {
                    console.error('‚ùå Error loading calendar events:', error);
                    failureCallback(error);
                });
        },

        // –ö–ª–∏–∫ –ø–æ —Å–æ–±—ã—Ç–∏—é
        eventClick: function(info) {
            info.jsEvent.preventDefault();
            showEventDetails(info.event);
        },

        // –ö–ª–∏–∫ –ø–æ –¥–∞—Ç–µ (–¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è)
        dateClick: function(info) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –¥–∞—Ç–∞ –Ω–µ –≤ –ø—Ä–æ—à–ª–æ–º
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const clickedDate = new Date(info.date);
            clickedDate.setHours(0, 0, 0, 0);

            if (clickedDate >= today) {
                console.log('üìÖ Date clicked:', info.dateStr);

                // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ —Ç–∞–±–ª–∏—á–Ω—ã–π –≤–∏–¥
                switchView('table');

                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É –∏ –∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ª–æ—Ç—ã
                setTimeout(() => {
                    // –ù–∞—Ö–æ–¥–∏–º –∫–Ω–æ–ø–∫—É –¥–Ω—è –∏–ª–∏ –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—É
                    const dayBtn = document.querySelector(`[data-date="${info.dateStr}"]`);
                    if (dayBtn) {
                        dayBtn.click();
                    } else {
                        // –ï—Å–ª–∏ –∫–Ω–æ–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ (–¥–∞—Ç–∞ –Ω–µ –≤ —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–µ),
                        // –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ –∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ª–æ—Ç—ã –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç—ã
                        if (window.selectedCourtData && window.selectedCourtData.id) {
                            if (window.loadTimeSlots) {
                                window.loadTimeSlots(window.selectedCourtData.id, info.dateStr);
                            }
                        }
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É
                        if (window.selectedDate !== undefined) {
                            window.selectedDate = new Date(info.dateStr);
                        }
                    }
                }, 200);
            } else {
                console.log('‚ö†Ô∏è Cannot select past date');
            }
        },

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–Ω–µ—à–Ω–µ–≥–æ –≤–∏–¥–∞
        eventClassNames: function(arg) {
            return ['fc-event-custom'];
        }
    });

    console.log('üìÖ Rendering calendar...');
    calendar.render();
    console.log('‚úÖ Calendar rendered successfully!');
    window.fullCalendar = calendar;

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ—Å—Ç–∏ –∫–Ω–æ–ø–æ–∫
    setTimeout(() => {
        const buttons = document.querySelectorAll('.fc-button');
        console.log(`üîç Found ${buttons.length} calendar buttons`);
        buttons.forEach((btn, idx) => {
            console.log(`  Button ${idx}: ${btn.textContent}, disabled: ${btn.disabled}`);
        });
    }, 500);

    // –§–∏–ª—å—Ç—Ä –ø–æ –∫–æ—Ä—Ç–∞–º
    document.querySelectorAll('.court-filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.court-filter-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            selectedCourtId = this.dataset.courtId;
            calendar.refetchEvents();
        });
    });
}

// –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏ —Å–æ–±—ã—Ç–∏—è
function showEventDetails(event) {
    const props = event.extendedProps;
    const modal = document.getElementById('eventModal');
    const modalBody = document.getElementById('modalBody');

    let statusBadge = '';
    if (props.status === 'confirmed') {
        statusBadge = '<span style="background: #10b981; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px;">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ</span>';
    } else if (props.status === 'pending') {
        statusBadge = '<span style="background: #f59e0b; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px;">–û–∂–∏–¥–∞–µ—Ç</span>';
    }

    const startDate = new Date(event.start);
    const endDate = new Date(event.end);

    let actions = '';
    if (props.isMine) {
        actions = `
            <div class="event-actions">
                <button class="btn-event btn-view" onclick="window.location.href='/users/profile/?tab=bookings'">
                    –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤ –ø—Ä–æ—Ñ–∏–ª–µ
                </button>
            </div>
        `;
    } else if (props.canJoin) {
        actions = `
            <div class="event-actions">
                <button class="btn-event btn-join" onclick="window.location.href='/booking/join/${props.bookingId}/'">
                    –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è
                </button>
            </div>
        `;
    }

    modalBody.innerHTML = `
        <div class="event-detail">
            <div class="event-detail-label">–ö–æ—Ä—Ç</div>
            <div class="event-detail-value">${props.courtName}</div>
        </div>
        <div class="event-detail">
            <div class="event-detail-label">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</div>
            <div class="event-detail-value">
                ${startDate.toLocaleDateString('ru-RU')} <br>
                ${startDate.toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'})} -
                ${endDate.toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'})}
            </div>
        </div>
        <div class="event-detail">
            <div class="event-detail-label">–°–æ–∑–¥–∞—Ç–µ–ª—å</div>
            <div class="event-detail-value">${props.creatorName}</div>
        </div>
        <div class="event-detail">
            <div class="event-detail-label">–°—Ç–∞—Ç—É—Å</div>
            <div class="event-detail-value">${statusBadge}</div>
        </div>
        <div class="event-detail">
            <div class="event-detail-label">–ò–≥—Ä–æ–∫–∏</div>
            <div class="event-detail-value">${props.partnersCount + 1} / ${props.maxPlayers}</div>
        </div>
        <div class="event-detail">
            <div class="event-detail-label">–°—Ç–æ–∏–º–æ—Å—Ç—å</div>
            <div class="event-detail-value">${props.price} ‚ÇΩ</div>
        </div>
        ${actions}
    `;

    modal.classList.add('active');
}

// –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
function closeEventModal() {
    document.getElementById('eventModal').classList.remove('active');
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ modal
document.addEventListener('click', function(e) {
    const modal = document.getElementById('eventModal');
    if (e.target === modal) {
        closeEventModal();
    }
});
</script>
{% endblock %}