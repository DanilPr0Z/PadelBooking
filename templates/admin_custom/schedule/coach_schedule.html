{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Ç—Ä–µ–Ω–µ—Ä–∞ | Paddle Booking Admin{% endblock %}

{% block extrastyle %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'admin_custom/css/schedule.css' %}">
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.css' rel='stylesheet' />
{% endblock %}

{% block content %}
<div class="schedule-container">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏—è -->
    <div class="schedule-header">
        <div>
            <h1>üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Ç—Ä–µ–Ω–µ—Ä–∞</h1>
            <p style="margin: 5px 0 0 0; color: #6b7280;">
                {{ coach.get_full_name|default:coach.username }}
                {% if coach.coach_profile.specialization %}
                - {{ coach.coach_profile.specialization }}
                {% endif %}
            </p>
        </div>

        <div class="schedule-nav">
            <a href="?week_start={{ prev_week }}" class="btn-nav">‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∞—è –Ω–µ–¥–µ–ª—è</a>
            <span class="current-week">
                {{ week_start|date:"d.m.Y" }} - {{ week_end|date:"d.m.Y" }}
            </span>
            <a href="?week_start={{ next_week }}" class="btn-nav">–°–ª–µ–¥—É—é—â–∞—è –Ω–µ–¥–µ–ª—è ‚Üí</a>
        </div>

        <div class="schedule-actions">
            <a href="{% url 'admin_courts_schedule' %}" class="btn-action">
                ‚Üê –í—Å–µ –∫–æ—Ä—Ç—ã
            </a>
            <button id="btnRefresh" class="btn-action" onclick="refreshCalendar()">
                üîÑ –û–±–Ω–æ–≤–∏—Ç—å
            </button>
            <button id="btnToday" class="btn-action" onclick="goToToday()">
                üìç –°–µ–≥–æ–¥–Ω—è
            </button>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç—Ä–µ–Ω–µ—Ä–∞ -->
    <div class="coach-stats">
        <div class="stat-card">
            <div class="stat-icon">üìä</div>
            <div>
                <div class="stat-value" id="totalBookings">-</div>
                <div class="stat-label">–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –Ω–∞ –Ω–µ–¥–µ–ª–µ</div>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">‚è±Ô∏è</div>
            <div>
                <div class="stat-value" id="totalHours">-</div>
                <div class="stat-label">–ß–∞—Å–æ–≤ —Ä–∞–±–æ—Ç—ã</div>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">üí∞</div>
            <div>
                <div class="stat-value" id="totalRevenue">-</div>
                <div class="stat-label">–î–æ—Ö–æ–¥</div>
            </div>
        </div>
    </div>

    <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å -->
    <div id="calendar"></div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–µ—Ç–∞–ª–µ–π -->
    <div id="bookingDetailsModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeDetailsModal()">&times;</span>
            <h2>–î–µ—Ç–∞–ª–∏ –∑–∞–Ω—è—Ç–∏—è #<span id="detailsBookingId"></span></h2>

            <div id="bookingDetailsContent"></div>

            <div class="form-actions">
                <button class="btn-danger" onclick="cancelBooking()">–û—Ç–º–µ–Ω–∏—Ç—å</button>
                <button class="btn-secondary" onclick="closeDetailsModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
    <div id="toast" class="toast"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/interaction@6.1.9/index.global.min.js"></script>
<script>
const coachId = {{ coach.id }};
const weekStart = '{{ week_start|date:"Y-m-d" }}';
const weekEnd = '{{ week_end|date:"Y-m-d" }}';

// CSRF Token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

let calendar;
let currentBookings = [];

document.addEventListener('DOMContentLoaded', function() {
    const calendarEl = document.getElementById('calendar');

    calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'timeGridWeek',
        locale: 'ru',
        firstDay: 1,
        slotMinTime: '08:00:00',
        slotMaxTime: '22:00:00',
        slotDuration: '01:00:00',
        height: 'auto',
        allDaySlot: false,

        headerToolbar: {
            left: '',
            center: '',
            right: ''
        },

        // –ò—Å—Ç–æ—á–Ω–∏–∫ —Å–æ–±—ã—Ç–∏–π
        events: async function(info, successCallback, failureCallback) {
            try {
                const params = new URLSearchParams({
                    start: info.startStr.split('T')[0],
                    end: info.endStr.split('T')[0]
                });

                const response = await fetch(`/admin-panel/schedule/api/bookings/?${params}`);
                if (!response.ok) throw new Error('Failed to fetch bookings');

                let allBookings = await response.json();

                // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å —ç—Ç–∏–º —Ç—Ä–µ–Ω–µ—Ä–æ–º
                const coachBookings = allBookings.filter(event => {
                    return event.extendedProps.coach_name;
                    // TODO: Better filtering by coach_id when available
                });

                currentBookings = coachBookings;
                updateCoachStats(coachBookings);

                successCallback(coachBookings);
            } catch (error) {
                console.error('Error fetching events:', error);
                failureCallback(error);
                showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π', 'error');
            }
        },

        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
        editable: true,
        eventResizableFromStart: true,

        eventDrop: async function(info) {
            await updateBooking(info.event);
        },

        eventResize: async function(info) {
            await updateBooking(info.event);
        },

        eventClick: function(info) {
            showBookingDetails(info.event);
        }
    });

    calendar.render();
});

// –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ç—Ä–µ–Ω–µ—Ä–∞
function updateCoachStats(bookings) {
    const totalBookings = bookings.length;

    let totalHours = 0;
    let totalRevenue = 0;

    bookings.forEach(booking => {
        const start = new Date(booking.start);
        const end = new Date(booking.end);
        const hours = (end - start) / (1000 * 60 * 60);

        totalHours += hours;
        totalRevenue += parseFloat(booking.extendedProps.total_price || 0);
    });

    document.getElementById('totalBookings').textContent = totalBookings;
    document.getElementById('totalHours').textContent = Math.round(totalHours * 10) / 10 + ' —á';
    document.getElementById('totalRevenue').textContent = Math.round(totalRevenue).toLocaleString() + ' ‚ÇΩ';
}

// –û–±–Ω–æ–≤–∏—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
async function updateBooking(event) {
    try {
        const bookingId = event.extendedProps.booking_id;

        const data = {
            date: event.start.toISOString().split('T')[0],
            start_time: event.start.toTimeString().substring(0, 5),
            end_time: event.end.toTimeString().substring(0, 5)
        };

        const response = await fetch(`/admin-panel/schedule/api/booking/${bookingId}/update/`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify(data)
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
        }

        showToast('–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ', 'success');
    } catch (error) {
        console.error('Error updating booking:', error);
        showToast(error.message, 'error');
        calendar.refetchEvents();
    }
}

// –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏
function showBookingDetails(event) {
    const modal = document.getElementById('bookingDetailsModal');
    const content = document.getElementById('bookingDetailsContent');
    const props = event.extendedProps;

    document.getElementById('detailsBookingId').textContent = props.booking_id;

    content.innerHTML = `
        <div class="details-grid">
            <div class="detail-item">
                <label>–ö–ª–∏–µ–Ω—Ç:</label>
                <span>${props.user_name}</span>
            </div>
            <div class="detail-item">
                <label>–ö–æ—Ä—Ç:</label>
                <span>${props.court_name}</span>
            </div>
            <div class="detail-item">
                <label>–î–∞—Ç–∞:</label>
                <span>${event.start.toLocaleDateString('ru-RU')}</span>
            </div>
            <div class="detail-item">
                <label>–í—Ä–µ–º—è:</label>
                <span>${event.start.toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'})} - ${event.end.toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'})}</span>
            </div>
            <div class="detail-item">
                <label>–°—Ç–∞—Ç—É—Å:</label>
                <span class="status-badge status-${props.status}">${getStatusLabel(props.status)}</span>
            </div>
            <div class="detail-item">
                <label>–°—Ç–æ–∏–º–æ—Å—Ç—å:</label>
                <span>${props.total_price} ‚ÇΩ</span>
            </div>
        </div>
    `;

    modal.style.display = 'flex';
    modal.dataset.bookingId = props.booking_id;
}

function closeDetailsModal() {
    document.getElementById('bookingDetailsModal').style.display = 'none';
}

function getStatusLabel(status) {
    const labels = {
        'pending': '–í –æ–∂–∏–¥–∞–Ω–∏–∏',
        'confirmed': '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ',
        'cancelled': '–û—Ç–º–µ–Ω–µ–Ω–æ',
        'completed': '–ó–∞–≤–µ—Ä—à–µ–Ω–æ'
    };
    return labels[status] || status;
}

// –û—Ç–º–µ–Ω–∏—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
async function cancelBooking() {
    const modal = document.getElementById('bookingDetailsModal');
    const bookingId = modal.dataset.bookingId;

    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å —ç—Ç–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ?')) {
        return;
    }

    try {
        const response = await fetch(`/admin-panel/schedule/api/booking/${bookingId}/delete/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': csrftoken
            }
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || '–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã');
        }

        showToast('–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ', 'success');
        closeDetailsModal();
        calendar.refetchEvents();
    } catch (error) {
        console.error('Error cancelling booking:', error);
        showToast(error.message, 'error');
    }
}

// –û–±–Ω–æ–≤–∏—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å
function refreshCalendar() {
    calendar.refetchEvents();
    showToast('–û–±–Ω–æ–≤–ª–µ–Ω–æ', 'success');
}

// –ü–µ—Ä–µ–π—Ç–∏ –∫ —Å–µ–≥–æ–¥–Ω—è
function goToToday() {
    window.location.href = `/admin-panel/schedule/coach/${coachId}/`;
}

// Toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
function showToast(message, type = 'info') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = `toast toast-${type} toast-show`;

    setTimeout(() => {
        toast.className = 'toast';
    }, 3000);
}
</script>

<style>
/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ç—Ä–µ–Ω–µ—Ä–∞ */
.coach-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.stat-card {
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    display: flex;
    align-items: center;
    gap: 16px;
}

.stat-icon {
    font-size: 32px;
    width: 56px;
    height: 56px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f3f4f6;
    border-radius: 12px;
}

.stat-value {
    font-size: 24px;
    font-weight: 700;
    color: #1e3a5f;
}

.stat-label {
    font-size: 13px;
    color: #6b7280;
    margin-top: 4px;
}
</style>
{% endblock %}
