{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∫–æ—Ä—Ç–æ–≤ | Paddle Booking Admin{% endblock %}

{% block extrastyle %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'admin_custom/css/schedule.css' %}">
<!-- FullCalendar CSS -->
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.css' rel='stylesheet' />
{% endblock %}

{% block content %}
<div class="schedule-container">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏—è -->
    <div class="schedule-header">
        <h1>üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∫–æ—Ä—Ç–æ–≤</h1>

        <div class="schedule-nav">
            <a href="?week_start={{ prev_week }}" class="btn-nav">‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∞—è –Ω–µ–¥–µ–ª—è</a>
            <span class="current-week">
                {{ week_start|date:"d.m.Y" }} - {{ week_end|date:"d.m.Y" }}
            </span>
            <a href="?week_start={{ next_week }}" class="btn-nav">–°–ª–µ–¥—É—é—â–∞—è –Ω–µ–¥–µ–ª—è ‚Üí</a>
        </div>

        <div class="schedule-actions">
            <button id="btnRefresh" class="btn-action" onclick="refreshCalendar()">
                üîÑ –û–±–Ω–æ–≤–∏—Ç—å
            </button>
            <button id="btnToday" class="btn-action" onclick="goToToday()">
                üìç –°–µ–≥–æ–¥–Ω—è
            </button>
            <button id="btnCreateBooking" class="btn-action btn-primary" onclick="openQuickCreateModal()">
                ‚ûï –°–æ–∑–¥–∞—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
            </button>
        </div>
    </div>

    <!-- –§–∏–ª—å—Ç—Ä—ã -->
    <div class="schedule-filters">
        <label>
            –°—Ç–∞—Ç—É—Å:
            <select id="filterStatus" onchange="applyFilters()">
                <option value="">–í—Å–µ</option>
                <option value="pending">–í –æ–∂–∏–¥–∞–Ω–∏–∏</option>
                <option value="confirmed">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ</option>
                <option value="cancelled">–û—Ç–º–µ–Ω–µ–Ω–æ</option>
            </select>
        </label>

        <label>
            –ö–æ—Ä—Ç:
            <select id="filterCourt" onchange="applyFilters()">
                <option value="">–í—Å–µ –∫–æ—Ä—Ç—ã</option>
                {% for court in courts %}
                <option value="{{ court.id }}">{{ court.name }}</option>
                {% endfor %}
            </select>
        </label>
    </div>

    <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å -->
    <div id="calendar"></div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –±—ã—Å—Ç—Ä–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è -->
    <div id="quickCreateModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeQuickCreateModal()">&times;</span>
            <h2>–°–æ–∑–¥–∞—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</h2>

            <form id="quickCreateForm">
                <div class="form-group">
                    <label>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å *</label>
                    <input type="text" id="searchUser" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –∏–º—è..." autocomplete="off">
                    <input type="hidden" id="userId" required>
                    <div id="userSuggestions" class="suggestions"></div>
                </div>

                <div class="form-group">
                    <label>–ö–æ—Ä—Ç *</label>
                    <select id="courtId" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ—Ä—Ç</option>
                        {% for court in courts %}
                        <option value="{{ court.id }}">{{ court.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>–î–∞—Ç–∞ *</label>
                        <input type="date" id="bookingDate" required>
                    </div>

                    <div class="form-group">
                        <label>–ù–∞—á–∞–ª–æ *</label>
                        <input type="time" id="startTime" required>
                    </div>

                    <div class="form-group">
                        <label>–ö–æ–Ω–µ—Ü *</label>
                        <input type="time" id="endTime" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>–°—Ç–∞—Ç—É—Å</label>
                    <select id="bookingStatus">
                        <option value="confirmed">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ</option>
                        <option value="pending">–í –æ–∂–∏–¥–∞–Ω–∏–∏</option>
                    </select>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeQuickCreateModal()">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn-primary">–°–æ–∑–¥–∞—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–µ—Ç–∞–ª–µ–π –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <div id="bookingDetailsModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeDetailsModal()">&times;</span>
            <h2>–î–µ—Ç–∞–ª–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è #<span id="detailsBookingId"></span></h2>

            <div id="bookingDetailsContent">
                <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è -->
            </div>

            <div class="form-actions">
                <button class="btn-danger" onclick="cancelBooking()">–û—Ç–º–µ–Ω–∏—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
                <button class="btn-secondary" onclick="closeDetailsModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
    <div id="toast" class="toast"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/resource-timeline@6.1.9/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/interaction@6.1.9/index.global.min.js"></script>
<script>
// –î–∞–Ω–Ω—ã–µ –∏–∑ Django
const courts = {{ courts|safe }};
const weekStart = '{{ week_start|date:"Y-m-d" }}';
const weekEnd = '{{ week_end|date:"Y-m-d" }}';

// CSRF Token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

// Calendar instance
let calendar;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
document.addEventListener('DOMContentLoaded', function() {
    const calendarEl = document.getElementById('calendar');

    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∫–æ—Ä—Ç—ã –≤ —Ä–µ—Å—É—Ä—Å—ã
    const resources = [
        {% for court in courts %}
        {
            id: '{{ court.id }}',
            title: '{{ court.name }}'
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

    calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'resourceTimelineWeek',
        schedulerLicenseKey: 'CC-Attribution-NonCommercial-NoDerivatives',
        locale: 'ru',
        firstDay: 1,  // –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫
        slotMinTime: '08:00:00',
        slotMaxTime: '22:00:00',
        slotDuration: '01:00:00',
        height: 'auto',

        resources: resources,

        headerToolbar: {
            left: '',
            center: '',
            right: ''
        },

        // –ò—Å—Ç–æ—á–Ω–∏–∫ —Å–æ–±—ã—Ç–∏–π
        events: async function(info, successCallback, failureCallback) {
            try {
                const params = new URLSearchParams({
                    start: info.startStr.split('T')[0],
                    end: info.endStr.split('T')[0]
                });

                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
                const statusFilter = document.getElementById('filterStatus').value;
                const courtFilter = document.getElementById('filterCourt').value;

                if (statusFilter) params.append('status', statusFilter);
                if (courtFilter) params.append('court_id', courtFilter);

                const response = await fetch(`/admin-panel/schedule/api/bookings/?${params}`);
                if (!response.ok) throw new Error('Failed to fetch bookings');

                const events = await response.json();
                successCallback(events);
            } catch (error) {
                console.error('Error fetching events:', error);
                failureCallback(error);
                showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π', 'error');
            }
        },

        // Drag and drop
        editable: true,
        eventResizableFromStart: true,

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è
        eventDrop: async function(info) {
            await updateBooking(info.event);
        },

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        eventResize: async function(info) {
            await updateBooking(info.event);
        },

        // –ö–ª–∏–∫ –ø–æ —Å–æ–±—ã—Ç–∏—é - –ø–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏
        eventClick: function(info) {
            showBookingDetails(info.event);
        },

        // –ö–ª–∏–∫ –ø–æ –ø—É—Å—Ç–æ–π —è—á–µ–π–∫–µ - —Å–æ–∑–¥–∞—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
        dateClick: function(info) {
            openQuickCreateModal(info.dateStr, info.resource?.id);
        }
    });

    calendar.render();
});

// –û–±–Ω–æ–≤–∏—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (drag-and-drop)
async function updateBooking(event) {
    try {
        const bookingId = event.extendedProps.booking_id;

        const data = {
            date: event.start.toISOString().split('T')[0],
            start_time: event.start.toTimeString().substring(0, 5),
            end_time: event.end.toTimeString().substring(0, 5),
            court_id: event.getResources()[0]?.id
        };

        const response = await fetch(`/admin-panel/schedule/api/booking/${bookingId}/update/`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify(data)
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
        }

        showToast('–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ', 'success');
    } catch (error) {
        console.error('Error updating booking:', error);
        showToast(error.message, 'error');
        calendar.refetchEvents();  // –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
    }
}

// –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
function showBookingDetails(event) {
    const modal = document.getElementById('bookingDetailsModal');
    const content = document.getElementById('bookingDetailsContent');
    const props = event.extendedProps;

    document.getElementById('detailsBookingId').textContent = props.booking_id;

    content.innerHTML = `
        <div class="details-grid">
            <div class="detail-item">
                <label>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</label>
                <span>${props.user_name}</span>
            </div>
            <div class="detail-item">
                <label>–ö–æ—Ä—Ç:</label>
                <span>${props.court_name}</span>
            </div>
            <div class="detail-item">
                <label>–î–∞—Ç–∞:</label>
                <span>${event.start.toLocaleDateString('ru-RU')}</span>
            </div>
            <div class="detail-item">
                <label>–í—Ä–µ–º—è:</label>
                <span>${event.start.toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'})} - ${event.end.toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'})}</span>
            </div>
            <div class="detail-item">
                <label>–°—Ç–∞—Ç—É—Å:</label>
                <span class="status-badge status-${props.status}">${getStatusLabel(props.status)}</span>
            </div>
            <div class="detail-item">
                <label>–°—Ç–æ–∏–º–æ—Å—Ç—å:</label>
                <span>${props.total_price} ‚ÇΩ</span>
            </div>
            ${props.coach_name ? `
            <div class="detail-item">
                <label>–¢—Ä–µ–Ω–µ—Ä:</label>
                <span>${props.coach_name}</span>
            </div>
            ` : ''}
            ${props.partners_count > 0 ? `
            <div class="detail-item">
                <label>–ü–∞—Ä—Ç–Ω–µ—Ä–æ–≤:</label>
                <span>${props.partners_count}</span>
            </div>
            ` : ''}
        </div>
    `;

    modal.style.display = 'flex';
    modal.dataset.bookingId = props.booking_id;
}

function closeDetailsModal() {
    document.getElementById('bookingDetailsModal').style.display = 'none';
}

function getStatusLabel(status) {
    const labels = {
        'pending': '–í –æ–∂–∏–¥–∞–Ω–∏–∏',
        'confirmed': '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ',
        'cancelled': '–û—Ç–º–µ–Ω–µ–Ω–æ',
        'completed': '–ó–∞–≤–µ—Ä—à–µ–Ω–æ'
    };
    return labels[status] || status;
}

// –û—Ç–º–µ–Ω–∏—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
async function cancelBooking() {
    const modal = document.getElementById('bookingDetailsModal');
    const bookingId = modal.dataset.bookingId;

    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å —ç—Ç–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ?')) {
        return;
    }

    try {
        const response = await fetch(`/admin-panel/schedule/api/booking/${bookingId}/delete/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': csrftoken
            }
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || '–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã');
        }

        showToast('–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ', 'success');
        closeDetailsModal();
        calendar.refetchEvents();
    } catch (error) {
        console.error('Error cancelling booking:', error);
        showToast(error.message, 'error');
    }
}

// –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è
function openQuickCreateModal(dateStr, resourceId) {
    const modal = document.getElementById('quickCreateModal');
    const form = document.getElementById('quickCreateForm');

    // –ó–∞–ø–æ–ª–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    if (dateStr) {
        const date = new Date(dateStr);
        document.getElementById('bookingDate').value = date.toISOString().split('T')[0];
        document.getElementById('startTime').value = date.toTimeString().substring(0, 5);

        // –ö–æ–Ω–µ—Ü –Ω–∞ 1 —á–∞—Å –ø–æ–∑–∂–µ
        date.setHours(date.getHours() + 1);
        document.getElementById('endTime').value = date.toTimeString().substring(0, 5);
    }

    if (resourceId) {
        document.getElementById('courtId').value = resourceId;
    }

    modal.style.display = 'flex';
}

function closeQuickCreateModal() {
    document.getElementById('quickCreateModal').style.display = 'none';
    document.getElementById('quickCreateForm').reset();
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è
document.getElementById('quickCreateForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const userId = document.getElementById('userId').value;
    if (!userId) {
        showToast('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
        return;
    }

    const data = {
        user_id: userId,
        court_id: document.getElementById('courtId').value,
        date: document.getElementById('bookingDate').value,
        start_time: document.getElementById('startTime').value,
        end_time: document.getElementById('endTime').value,
        status: document.getElementById('bookingStatus').value
    };

    try {
        const response = await fetch('/admin-panel/schedule/api/booking/create/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify(data)
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è');
        }

        const result = await response.json();
        showToast('–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ', 'success');
        closeQuickCreateModal();
        calendar.refetchEvents();
    } catch (error) {
        console.error('Error creating booking:', error);
        showToast(error.message, 'error');
    }
});

// –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ø—Ä–æ—Å—Ç–æ–π –ø—Ä–∏–º–µ—Ä - –º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å —Å AJAX)
document.getElementById('searchUser').addEventListener('input', function(e) {
    // TODO: Implement user search with AJAX
    // For now, just a placeholder
});

// –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
function applyFilters() {
    calendar.refetchEvents();
}

// –û–±–Ω–æ–≤–∏—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å
function refreshCalendar() {
    calendar.refetchEvents();
    showToast('–û–±–Ω–æ–≤–ª–µ–Ω–æ', 'success');
}

// –ü–µ—Ä–µ–π—Ç–∏ –∫ —Å–µ–≥–æ–¥–Ω—è
function goToToday() {
    window.location.href = '/admin-panel/schedule/courts/';
}

// Toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
function showToast(message, type = 'info') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = `toast toast-${type} toast-show`;

    setTimeout(() => {
        toast.className = 'toast';
    }, 3000);
}
</script>
{% endblock %}
