{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ | Paddle Booking Admin{% endblock %}

{% block extrastyle %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'admin_custom/css/analytics.css' %}">
{% endblock %}

{% block content %}
<div class="analytics-dashboard">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã -->
    <div class="dashboard-header">
        <h1>üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h1>

        <div class="period-selector">
            <select id="periodSelect" onchange="changePeriod(this.value)">
                <option value="7days" {% if period == '7days' %}selected{% endif %}>–ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</option>
                <option value="30days" {% if period == '30days' %}selected{% endif %}>–ü–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π</option>
                <option value="90days" {% if period == '90days' %}selected{% endif %}>–ü–æ—Å–ª–µ–¥–Ω–∏–µ 90 –¥–Ω–µ–π</option>
                <option value="year" {% if period == 'year' %}selected{% endif %}>–ì–æ–¥</option>
            </select>

            <a href="{% url 'admin_export_excel' %}?period={{ period }}" class="btn-export">
                üì• –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
            </a>
        </div>
    </div>

    <!-- –ú–µ—Ç—Ä–∏–∫–∏ -->
    <div class="metrics-grid">
        <div class="metric-card">
            <div class="metric-icon">üí∞</div>
            <div class="metric-value">{{ financial.total_revenue|floatformat:0 }} ‚ÇΩ</div>
            <div class="metric-label">–û–±—â–∏–π –¥–æ—Ö–æ–¥</div>
            <div class="metric-change {% if financial.paid_amount >= financial.total_revenue %}positive{% endif %}">
                –û–ø–ª–∞—á–µ–Ω–æ: {{ financial.paid_amount|floatformat:0 }} ‚ÇΩ
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-icon">üìà</div>
            <div class="metric-value">{{ occupancy.overall_occupancy_rate }}%</div>
            <div class="metric-label">–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç—å</div>
            <div class="metric-change">
                {{ occupancy.total_bookings }} –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-icon">üë•</div>
            <div class="metric-value">{{ clients.active_users }}</div>
            <div class="metric-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤</div>
            <div class="metric-change positive">
                +{{ clients.new_users }} –Ω–æ–≤—ã—Ö
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-icon">üíé</div>
            <div class="metric-value">{{ clients.avg_ltv|floatformat:0 }} ‚ÇΩ</div>
            <div class="metric-label">–°—Ä–µ–¥–Ω–∏–π LTV</div>
            <div class="metric-change">
                Retention: {{ clients.retention_rate }}%
            </div>
        </div>
    </div>

    <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
    <div class="charts-grid">
        <!-- –ì—Ä–∞—Ñ–∏–∫ –¥–æ—Ö–æ–¥–∞ -->
        <div class="chart-card">
            <h3>–î–∏–Ω–∞–º–∏–∫–∞ –¥–æ—Ö–æ–¥–∞</h3>
            <canvas id="revenueChart"></canvas>
        </div>

        <!-- –ì—Ä–∞—Ñ–∏–∫ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç–∏ -->
        <div class="chart-card">
            <h3>–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç—å –∫–æ—Ä—Ç–æ–≤</h3>
            <canvas id="occupancyChart"></canvas>
        </div>

        <!-- –ì—Ä–∞—Ñ–∏–∫ –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏ -->
        <div class="chart-card">
            <h3>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏</h3>
            <canvas id="weekdayChart"></canvas>
        </div>

        <!-- –ì—Ä–∞—Ñ–∏–∫ –ø–æ —á–∞—Å–∞–º -->
        <div class="chart-card">
            <h3>–ü–∏–∫–æ–≤—ã–µ —á–∞—Å—ã</h3>
            <canvas id="hourlyChart"></canvas>
        </div>
    </div>

    <!-- –¢–∞–±–ª–∏—Ü—ã -->
    <div class="tables-grid">
        <!-- –¢–æ–ø –∫–ª–∏–µ–Ω—Ç—ã -->
        <div class="table-card">
            <h3>–¢–æ–ø –∫–ª–∏–µ–Ω—Ç—ã</h3>
            <table class="modern-table">
                <thead>
                    <tr>
                        <th>–ò–º—è</th>
                        <th>–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π</th>
                        <th>–ü–æ—Ç—Ä–∞—á–µ–Ω–æ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for client in clients.top_clients|slice:":10" %}
                    <tr>
                        <td>{{ client.name }}</td>
                        <td>{{ client.bookings_count }}</td>
                        <td>{{ client.total_spent|floatformat:0 }} ‚ÇΩ</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="3" style="text-align: center; color: #999;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- –î–æ—Ö–æ–¥ –ø–æ –∫–æ—Ä—Ç–∞–º -->
        <div class="table-card">
            <h3>–î–æ—Ö–æ–¥ –ø–æ –∫–æ—Ä—Ç–∞–º</h3>
            <table class="modern-table">
                <thead>
                    <tr>
                        <th>–ö–æ—Ä—Ç</th>
                        <th>–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π</th>
                        <th>–î–æ—Ö–æ–¥</th>
                    </tr>
                </thead>
                <tbody>
                    {% for court in financial.revenue_by_court|slice:":10" %}
                    <tr>
                        <td>{{ court.court__name }}</td>
                        <td>{{ court.bookings_count }}</td>
                        <td>{{ court.revenue|floatformat:0 }} ‚ÇΩ</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="3" style="text-align: center; color: #999;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// –î–∞–Ω–Ω—ã–µ –∏–∑ Django
const financialData = {{ financial_json|safe }};
const occupancyData = {{ occupancy_json|safe }};
const clientsData = {{ clients_json|safe }};

// –§—É–Ω–∫—Ü–∏—è —Å–º–µ–Ω—ã –ø–µ—Ä–∏–æ–¥–∞
function changePeriod(period) {
    window.location.href = '?period=' + period;
}

// –¶–≤–µ—Ç–∞ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
const colors = {
    primary: '#9ef01a',
    secondary: '#1e3a5f',
    success: '#10b981',
    warning: '#fbbf24',
    error: '#ef4444',
    info: '#3b82f6'
};

// –ì—Ä–∞—Ñ–∏–∫ –¥–æ—Ö–æ–¥–∞ –ø–æ –º–µ—Å—è—Ü–∞–º
if (financialData.monthly_revenue && financialData.monthly_revenue.length > 0) {
    const ctx1 = document.getElementById('revenueChart').getContext('2d');
    new Chart(ctx1, {
        type: 'line',
        data: {
            labels: financialData.monthly_revenue.map(d => {
                const date = new Date(d.month);
                return date.toLocaleDateString('ru-RU', { month: 'short', year: 'numeric' });
            }),
            datasets: [{
                label: '–î–æ—Ö–æ–¥',
                data: financialData.monthly_revenue.map(d => d.revenue),
                borderColor: colors.primary,
                backgroundColor: colors.primary + '20',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: value => value.toLocaleString() + ' ‚ÇΩ'
                    }
                }
            }
        }
    });
}

// –ì—Ä–∞—Ñ–∏–∫ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç–∏ –∫–æ—Ä—Ç–æ–≤
if (occupancyData.court_occupancy && occupancyData.court_occupancy.length > 0) {
    const ctx2 = document.getElementById('occupancyChart').getContext('2d');
    new Chart(ctx2, {
        type: 'bar',
        data: {
            labels: occupancyData.court_occupancy.map(d => d.court__name),
            datasets: [{
                label: '–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç—å %',
                data: occupancyData.court_occupancy.map(d => d.occupancy_rate),
                backgroundColor: colors.primary,
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        callback: value => value + '%'
                    }
                }
            }
        }
    });
}

// –ì—Ä–∞—Ñ–∏–∫ –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏
if (occupancyData.weekday_occupancy && occupancyData.weekday_occupancy.length > 0) {
    const weekdays = ['–í—Å', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±'];
    const ctx3 = document.getElementById('weekdayChart').getContext('2d');
    new Chart(ctx3, {
        type: 'bar',
        data: {
            labels: occupancyData.weekday_occupancy.map(d => weekdays[d.weekday - 1]),
            datasets: [{
                label: '–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π',
                data: occupancyData.weekday_occupancy.map(d => d.bookings_count),
                backgroundColor: [
                    colors.info,
                    colors.primary,
                    colors.primary,
                    colors.primary,
                    colors.primary,
                    colors.primary,
                    colors.warning
                ],
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}

// –ì—Ä–∞—Ñ–∏–∫ –ø–æ —á–∞—Å–∞–º
if (occupancyData.hourly_occupancy && occupancyData.hourly_occupancy.length > 0) {
    const ctx4 = document.getElementById('hourlyChart').getContext('2d');
    new Chart(ctx4, {
        type: 'line',
        data: {
            labels: occupancyData.hourly_occupancy.map(d => d.hour + ':00'),
            datasets: [{
                label: '–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π',
                data: occupancyData.hourly_occupancy.map(d => d.bookings_count),
                borderColor: colors.info,
                backgroundColor: colors.info + '20',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}
</script>
{% endblock %}
