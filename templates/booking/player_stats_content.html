{% load static %}

<!-- CSS —Å—Ç–∏–ª–∏ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
<style>
    .stats-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }

    .stats-header {
        text-align: center;
        margin-bottom: 40px;
    }

    .stats-title {
        font-size: 36px;
        font-weight: 700;
        background: linear-gradient(135deg, #9ef01a 0%, #bff167 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 10px;
    }

    .stats-subtitle {
        font-size: 16px;
        color: #6b7280;
    }

    /* –ö–∞—Ä—Ç–æ—á–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
    }

    .stat-card {
        background: white;
        padding: 25px;
        border-radius: 16px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.07);
        transition: transform 0.2s, box-shadow 0.2s;
        position: relative;
        overflow: hidden;
    }

    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 15px rgba(0,0,0,0.12);
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: linear-gradient(90deg, #9ef01a, #bff167);
    }

    .stat-icon {
        font-size: 36px;
        margin-bottom: 10px;
    }

    .stat-value {
        font-size: 32px;
        font-weight: 700;
        color: #1a1a1a;
        margin-bottom: 5px;
    }

    .stat-label {
        font-size: 14px;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* –ì—Ä–∞—Ñ–∏–∫–∏ */
    .charts-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        gap: 30px;
        margin-bottom: 40px;
    }

    .chart-card {
        background: white;
        padding: 30px;
        border-radius: 16px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.07);
    }

    .chart-title {
        font-size: 20px;
        font-weight: 700;
        margin-bottom: 20px;
        color: #1a1a1a;
    }

    /* –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è */
    .achievements-section {
        background: white;
        padding: 30px;
        border-radius: 16px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.07);
        margin-bottom: 40px;
    }

    .achievements-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .achievement-card {
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        background: #f3f4f6;
        transition: all 0.3s;
    }

    .achievement-card.unlocked {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3);
    }

    .achievement-card.unlocked.platinum {
        background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
        box-shadow: 0 4px 12px rgba(158, 240, 26, 0.3);
    }

    .achievement-card.unlocked.diamond {
        background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        box-shadow: 0 4px 12px rgba(158, 240, 26, 0.4);
    }

    .achievement-icon {
        font-size: 48px;
        margin-bottom: 10px;
        filter: grayscale(100%);
    }

    .achievement-card.unlocked .achievement-icon {
        filter: grayscale(0%);
        animation: bounce 0.5s ease;
    }

    @keyframes bounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-10px); }
    }

    .achievement-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 5px;
        color: #1a1a1a;
    }

    .achievement-desc {
        font-size: 12px;
        color: #6b7280;
    }

    .achievement-progress {
        width: 100%;
        height: 6px;
        background: #e5e7eb;
        border-radius: 3px;
        margin-top: 10px;
        overflow: hidden;
    }

    .achievement-progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #9ef01a, #bff167);
        transition: width 0.3s ease;
    }

    /* –õ—é–±–∏–º—ã–µ –ø–∞—Ä—Ç–Ω–µ—Ä—ã */
    .partners-section {
        background: white;
        padding: 30px;
        border-radius: 16px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.07);
        margin-bottom: 40px;
    }

    .partner-item {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 15px;
        margin-bottom: 10px;
        background: #f9fafb;
        border-radius: 12px;
        transition: background 0.2s;
    }

    .partner-item:hover {
        background: #f3f4f6;
    }

    .partner-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: linear-gradient(135deg, #9ef01a, #bff167);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #1e3a5f;
        font-size: 20px;
        font-weight: 600;
    }

    .partner-info {
        flex: 1;
    }

    .partner-name {
        font-size: 16px;
        font-weight: 600;
        color: #1a1a1a;
    }

    .partner-games {
        font-size: 14px;
        color: #6b7280;
    }

    /* –†–µ–π—Ç–∏–Ω–≥ –ø—Ä–æ–≥—Ä–µ—Å—Å */
    .rating-section {
        background: white;
        padding: 30px;
        border-radius: 16px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.07);
        margin-bottom: 40px;
    }

    .rating-current {
        text-align: center;
        padding: 30px;
        background: linear-gradient(135deg, #9ef01a 0%, #bff167 100%);
        border-radius: 12px;
        color: #1e3a5f;
        margin-bottom: 20px;
    }

    .rating-level {
        font-size: 48px;
        font-weight: 700;
        margin-bottom: 10px;
    }

    .rating-numeric {
        font-size: 24px;
        opacity: 0.9;
    }

    /* ========== –¢–ï–ú–ù–ê–Ø –¢–ï–ú–ê ========== */
    :root[data-theme="dark"] .stats-container {
        background: transparent;
    }

    :root[data-theme="dark"] .stats-subtitle {
        color: var(--gray-color);
    }

    :root[data-theme="dark"] .stat-card {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
    }

    :root[data-theme="dark"] .stat-value {
        color: var(--text-color);
    }

    :root[data-theme="dark"] .stat-label {
        color: var(--gray-color);
    }

    :root[data-theme="dark"] .chart-card {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
    }

    :root[data-theme="dark"] .chart-title {
        color: var(--text-color);
    }

    :root[data-theme="dark"] .partners-section {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
    }

    :root[data-theme="dark"] .section-title {
        color: var(--text-color);
    }

    :root[data-theme="dark"] .partner-item {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--card-border);
    }

    :root[data-theme="dark"] .partner-item:hover {
        background: rgba(255, 255, 255, 0.08);
    }

    :root[data-theme="dark"] .partner-name {
        color: var(--text-color);
    }

    :root[data-theme="dark"] .partner-games {
        color: var(--gray-color);
    }

    :root[data-theme="dark"] .rating-section {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
    }

    :root[data-theme="dark"] .achievements-grid {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
    }

    :root[data-theme="dark"] .achievement-card {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--card-border);
    }

    :root[data-theme="dark"] .achievement-title {
        color: var(--text-color);
    }

    :root[data-theme="dark"] .achievement-desc {
        color: var(--gray-color);
    }

    :root[data-theme="dark"] .rating-current {
        background: linear-gradient(135deg, #9ef01a 0%, #bff167 100%);
        color: #1e3a5f;
    }

    :root[data-theme="dark"] .achievements-section {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
    }

    @media (max-width: 768px) {
        .charts-section {
            grid-template-columns: 1fr;
        }

        .stat-value {
            font-size: 24px;
        }

        .stats-title {
            font-size: 28px;
        }
    }
</style>

<!-- HTML –∫–æ–Ω—Ç–µ–Ω—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
<div class="stats-container">
    <!-- Header -->
    <div class="stats-header">
        <h1 class="stats-title">üìä –ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h1>
        <p class="stats-subtitle">–ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –≤–∞—à–µ–π –∏–≥—Ä–æ–≤–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</p>
    </div>

    {% if stats %}
    <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">üéæ</div>
            <div class="stat-value">{{ stats.total_games }}</div>
            <div class="stat-label">–í—Å–µ–≥–æ –∏–≥—Ä</div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">‚è±Ô∏è</div>
            <div class="stat-value">{{ stats.total_hours }}</div>
            <div class="stat-label">–ß–∞—Å–æ–≤ –Ω–∞ –∫–æ—Ä—Ç–µ</div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">üí∞</div>
            <div class="stat-value">{{ stats.total_spent }}</div>
            <div class="stat-label">–ü–æ—Ç—Ä–∞—á–µ–Ω–æ (‚ÇΩ)</div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">üìÖ</div>
            <div class="stat-value">{{ stats.upcoming_games }}</div>
            <div class="stat-label">–ü—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö –∏–≥—Ä</div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">üî•</div>
            <div class="stat-value">{{ stats.games_per_week }}</div>
            <div class="stat-label">–ò–≥—Ä –≤ –Ω–µ–¥–µ–ª—é</div>
        </div>

        {% if stats.favorite_court %}
        <div class="stat-card">
            <div class="stat-icon">üèÜ</div>
            <div class="stat-value" style="font-size: 20px;">{{ stats.favorite_court.court__name }}</div>
            <div class="stat-label">–õ—é–±–∏–º—ã–π –∫–æ—Ä—Ç</div>
        </div>
        {% endif %}
    </div>

    <!-- –†–µ–π—Ç–∏–Ω–≥ -->
    {% if stats.current_rating %}
    <div class="rating-section">
        <h2 class="chart-title">–í–∞—à —Ä–µ–π—Ç–∏–Ω–≥</h2>
        <div class="rating-current">
            <div class="rating-level">{{ stats.current_rating.level }}</div>
            <div class="rating-numeric">{{ stats.current_rating.numeric }} / 7.00</div>
        </div>
        {% if stats.rating_progress %}
        <div style="height: 300px;">
            <canvas id="ratingChart"></canvas>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
    <div class="charts-section">
        <div class="chart-card">
            <h3 class="chart-title">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –º–µ—Å—è—Ü–∞–º</h3>
            <canvas id="monthlyChart"></canvas>
        </div>

        <div class="chart-card">
            <h3 class="chart-title">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏</h3>
            <canvas id="weekdayChart"></canvas>
        </div>
    </div>

    <!-- –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è -->
    {% if stats.achievements %}
    <div class="achievements-section">
        <h2 class="chart-title">üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h2>
        <div class="achievements-grid">
            {% for achievement in stats.achievements %}
            <div class="achievement-card {% if achievement.unlocked %}unlocked {{ achievement.type }}{% endif %}">
                <div class="achievement-icon">{{ achievement.title|slice:":2" }}</div>
                <div class="achievement-title">{{ achievement.title|slice:"2:" }}</div>
                <div class="achievement-desc">{{ achievement.description }}</div>
                {% if not achievement.unlocked %}
                <div class="achievement-progress">
                    <div class="achievement-progress-bar" style="width: {{ achievement.progress }}%"></div>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- –õ—é–±–∏–º—ã–µ –ø–∞—Ä—Ç–Ω–µ—Ä—ã -->
    {% if stats.favorite_partners %}
    <div class="partners-section">
        <h2 class="chart-title">üë• –õ—é–±–∏–º—ã–µ –ø–∞—Ä—Ç–Ω–µ—Ä—ã</h2>
        {% for partner in stats.favorite_partners %}
        <div class="partner-item">
            <div class="partner-avatar">
                {{ partner.full_name|slice:":1"|upper }}
            </div>
            <div class="partner-info">
                <div class="partner-name">{{ partner.full_name }}</div>
                <div class="partner-games">{{ partner.games_count }} –∏–≥—Ä –≤–º–µ—Å—Ç–µ</div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {% else %}
    <div style="text-align: center; padding: 60px 20px;">
        <h3 style="color: var(--gray-color); font-size: 1.3rem;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</h3>
        <p style="color: var(--gray-color); margin-top: 10px;">–ù–∞—á–Ω–∏—Ç–µ –∏–≥—Ä–∞—Ç—å, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å–≤–æ—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É!</p>
    </div>
    {% endif %}
</div>

<!-- Chart.js –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
{% if stats %}
// –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–µ–º—ã
function getChartColors() {
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';

    if (isDark) {
        return {
            gridColor: 'rgba(255, 255, 255, 0.1)',
            textColor: '#e5e7eb',
            primaryColor: '#9ef01a',
            primaryBg: 'rgba(158, 240, 26, 0.2)'
        };
    } else {
        return {
            gridColor: 'rgba(0, 0, 0, 0.1)',
            textColor: '#374151',
            primaryColor: '#9ef01a',
            primaryBg: 'rgba(158, 240, 26, 0.1)'
        };
    }
}

const colors = getChartColors();

// –ü—Ä–∏–º–µ–Ω—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Ü–≤–µ—Ç–∞ –∫ Chart.js
Chart.defaults.color = colors.textColor;
Chart.defaults.borderColor = colors.gridColor;

// –ì—Ä–∞—Ñ–∏–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ –º–µ—Å—è—Ü–∞–º
const monthlyData = {{ monthly_activity_json|safe }};
const monthlyLabels = monthlyData.map(item => {
    const date = new Date(item.month + '-01');
    return date.toLocaleDateString('ru-RU', { month: 'short', year: 'numeric' });
});
const monthlyValues = monthlyData.map(item => item.games);

new Chart(document.getElementById('monthlyChart'), {
    type: 'line',
    data: {
        labels: monthlyLabels,
        datasets: [{
            label: '–ò–≥—Ä',
            data: monthlyValues,
            borderColor: '#9ef01a',
            backgroundColor: 'rgba(158, 240, 26, 0.1)',
            tension: 0.4,
            fill: true,
            pointBackgroundColor: '#9ef01a',
            pointBorderColor: '#fff',
            pointHoverBackgroundColor: '#fff',
            pointHoverBorderColor: '#9ef01a'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1,
                    color: colors.textColor
                },
                grid: {
                    color: colors.gridColor
                }
            },
            x: {
                ticks: {
                    color: colors.textColor
                },
                grid: {
                    color: colors.gridColor
                }
            }
        }
    }
});

// –ì—Ä–∞—Ñ–∏–∫ –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏
const weekdayData = {{ weekday_stats_json|safe }};
const weekdayLabels = weekdayData.map(item => item.day);
const weekdayValues = weekdayData.map(item => item.games);

new Chart(document.getElementById('weekdayChart'), {
    type: 'bar',
    data: {
        labels: weekdayLabels,
        datasets: [{
            label: '–ò–≥—Ä',
            data: weekdayValues,
            backgroundColor: [
                'rgba(158, 240, 26, 0.9)',
                'rgba(191, 241, 103, 0.9)',
                'rgba(158, 240, 26, 0.7)',
                'rgba(191, 241, 103, 0.7)',
                'rgba(158, 240, 26, 0.85)',
                'rgba(191, 241, 103, 0.85)',
                'rgba(158, 240, 26, 0.95)'
            ],
            borderColor: '#9ef01a',
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1,
                    color: colors.textColor
                },
                grid: {
                    color: colors.gridColor
                }
            },
            x: {
                ticks: {
                    color: colors.textColor
                },
                grid: {
                    color: colors.gridColor
                }
            }
        }
    }
});

// –ì—Ä–∞—Ñ–∏–∫ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞
{% if stats.rating_progress %}
const ratingData = {{ rating_progress_json|safe }};
const ratingLabels = ratingData.map(item => {
    const date = new Date(item.date);
    return date.toLocaleDateString('ru-RU', { month: 'short', day: 'numeric' });
});
const ratingValues = ratingData.map(item => parseFloat(item.rating));

new Chart(document.getElementById('ratingChart'), {
    type: 'line',
    data: {
        labels: ratingLabels,
        datasets: [{
            label: '–†–µ–π—Ç–∏–Ω–≥',
            data: ratingValues,
            borderColor: '#9ef01a',
            backgroundColor: 'rgba(158, 240, 26, 0.1)',
            tension: 0.4,
            fill: true,
            pointRadius: 5,
            pointHoverRadius: 7,
            pointBackgroundColor: '#9ef01a',
            pointBorderColor: '#fff',
            pointHoverBackgroundColor: '#fff',
            pointHoverBorderColor: '#9ef01a'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                min: 1,
                max: 7,
                ticks: {
                    stepSize: 0.5,
                    color: colors.textColor
                },
                grid: {
                    color: colors.gridColor
                }
            },
            x: {
                ticks: {
                    color: colors.textColor
                },
                grid: {
                    color: colors.gridColor
                }
            }
        }
    }
});
{% endif %}

// –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫–∏ –ø—Ä–∏ —Å–º–µ–Ω–µ —Ç–µ–º—ã
window.addEventListener('storage', function(e) {
    if (e.key === 'theme') {
        location.reload();
    }
});
{% endif %}
</script>
