{% extends 'base.html' %}

{% block title %}Найти напарника - Paddle Booking{% endblock %}

{% block content %}
<div class="find-partners-container">
    <div class="page-header">
        <h1><i class="fas fa-user-friends"></i> Найти напарника для игры</h1>
        <p>Присоединяйтесь к существующим бронированиям или найдите партнеров для игры</p>
    </div>

    {% if bookings %}
        <div class="bookings-grid">
            {% for booking in bookings %}
            <div class="partner-booking-card">
                <div class="booking-header">
                    <div class="booking-date">
                        <i class="fas fa-calendar"></i>
                        {{ booking.date|date:"d.m.Y" }}
                    </div>
                    <div class="booking-time">
                        <i class="fas fa-clock"></i>
                        {{ booking.start_time|time:"H:i" }} - {{ booking.end_time|time:"H:i" }}
                    </div>
                </div>

                <div class="booking-body">
                    <div class="court-info">
                        <h3>{{ booking.court.name }}</h3>
                        <p class="court-description">{{ booking.court.description|truncatewords:15 }}</p>
                    </div>

                    <div class="organizer-info">
                        <div class="organizer-avatar">
                            {% if booking.user.profile.avatar %}
                                <img src="{{ booking.user.profile.avatar.url }}" alt="{{ booking.user.get_full_name }}">
                            {% else %}
                                <i class="fas fa-user"></i>
                            {% endif %}
                        </div>
                        <div>
                            <p class="organizer-name">{{ booking.user.first_name }} {{ booking.user.last_name }}</p>
                            {% if booking.user.rating %}
                            <p class="organizer-rating">
                                <i class="fas fa-star"></i>
                                Уровень: {{ booking.user.rating.level }}
                            </p>
                            {% endif %}
                        </div>
                    </div>

                    <div class="booking-details">
                        <div class="detail-row">
                            <span class="detail-label">Игроки:</span>
                            <span class="detail-value">
                                {{ booking.partners.count|add:1 }} / {{ booking.max_players }}
                                <span class="slots-available">(свободно: {{ booking.available_slots }})</span>
                            </span>
                        </div>

                        <div class="detail-row">
                            <span class="detail-label">Стоимость на человека:</span>
                            <span class="detail-value price">{{ booking.price_per_person }} руб.</span>
                        </div>

                        {% if booking.required_rating_level %}
                        <div class="detail-row">
                            <span class="detail-label">Требуемый уровень:</span>
                            <span class="detail-value rating-badge">{{ booking.required_rating_level }}</span>
                        </div>
                        {% endif %}
                    </div>

                    <div class="participants-list">
                        <p class="participants-title">Участники:</p>
                        <div class="participants-avatars">
                            <div class="participant-avatar" title="{{ booking.user.get_full_name }} (организатор)">
                                {% if booking.user.profile.avatar %}
                                    <img src="{{ booking.user.profile.avatar.url }}" alt="{{ booking.user.get_full_name }}">
                                {% else %}
                                    <i class="fas fa-user"></i>
                                {% endif %}
                                <span class="organizer-badge">Орг.</span>
                            </div>
                            {% for partner in booking.partners.all %}
                            <div class="participant-avatar" title="{{ partner.get_full_name }}">
                                {% if partner.profile.avatar %}
                                    <img src="{{ partner.profile.avatar.url }}" alt="{{ partner.get_full_name }}">
                                {% else %}
                                    <i class="fas fa-user"></i>
                                {% endif %}
                            </div>
                            {% endfor %}
                            {% for i in booking.available_slots|make_list %}
                            <div class="participant-avatar empty">
                                <i class="fas fa-question"></i>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div class="booking-footer">
                    {% if booking.can_join_flag %}
                        <button class="btn-primary join-btn" data-booking-id="{{ booking.id }}" onclick="joinBooking({{ booking.id }})">
                            <i class="fas fa-user-plus"></i> Присоединиться
                        </button>
                    {% else %}
                        <button class="btn-secondary" disabled title="{{ booking.join_message }}">
                            <i class="fas fa-lock"></i> {{ booking.join_message }}
                        </button>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="no-bookings">
            <i class="fas fa-users-slash"></i>
            <h2>Нет доступных бронирований</h2>
            <p>Пока никто не ищет партнеров для игры</p>
            <a href="{% url 'booking' %}" class="btn-primary">
                <i class="fas fa-plus"></i> Создать бронирование
            </a>
        </div>
    {% endif %}
</div>

<style>
.find-partners-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 30px 20px;
}

.page-header {
    text-align: center;
    margin-bottom: 40px;
}

.page-header h1 {
    color: var(--primary-color);
    font-size: 2.5rem;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
}

.page-header p {
    color: #666;
    font-size: 1.1rem;
}

.bookings-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
    gap: 25px;
}

.partner-booking-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    transition: all 0.3s;
}

.partner-booking-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
}

.booking-header {
    background: linear-gradient(135deg, var(--primary-color) 0%, #764ba2 100%);
    color: white;
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
}

.booking-date, .booking-time {
    display: flex;
    align-items: center;
    gap: 8px;
}

.booking-body {
    padding: 20px;
}

.court-info h3 {
    color: var(--secondary-color);
    margin-bottom: 5px;
}

.court-description {
    color: #666;
    font-size: 0.9rem;
    margin-bottom: 15px;
}

.organizer-info {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: #f8f9fa;
    border-radius: 8px;
    margin-bottom: 15px;
}

.organizer-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    overflow: hidden;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.5rem;
    flex-shrink: 0;
}

.organizer-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.organizer-name {
    font-weight: 600;
    color: var(--secondary-color);
    margin: 0;
}

.organizer-rating {
    color: #666;
    font-size: 0.85rem;
    margin: 4px 0 0 0;
}

.booking-details {
    margin: 15px 0;
}

.detail-row {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid #f0f0f0;
}

.detail-label {
    color: #666;
}

.detail-value {
    font-weight: 600;
    color: var(--secondary-color);
}

.price {
    color: var(--primary-color);
    font-size: 1.1rem;
}

.slots-available {
    color: #28a745;
    font-weight: normal;
    font-size: 0.9rem;
}

.rating-badge {
    background: var(--primary-color);
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.85rem;
}

.participants-list {
    margin-top: 15px;
}

.participants-title {
    color: #666;
    font-size: 0.9rem;
    margin-bottom: 10px;
}

.participants-avatars {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.participant-avatar {
    position: relative;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    overflow: hidden;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1rem;
    border: 2px solid white;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.participant-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.participant-avatar.empty {
    background: #e0e0e0;
    color: #999;
}

.organizer-badge {
    position: absolute;
    bottom: -5px;
    right: -5px;
    background: #ff9800;
    color: white;
    font-size: 0.6rem;
    padding: 2px 4px;
    border-radius: 4px;
    font-weight: 600;
}

.booking-footer {
    padding: 15px 20px;
    border-top: 1px solid #f0f0f0;
}

.join-btn {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.no-bookings {
    text-align: center;
    padding: 80px 20px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.no-bookings i {
    font-size: 5rem;
    color: #ccc;
    margin-bottom: 20px;
}

.no-bookings h2 {
    color: var(--secondary-color);
    margin-bottom: 10px;
}

.no-bookings p {
    color: #666;
    margin-bottom: 30px;
    font-size: 1.1rem;
}

@media (max-width: 768px) {
    .bookings-grid {
        grid-template-columns: 1fr;
    }

    .page-header h1 {
        font-size: 2rem;
        flex-direction: column;
    }
}
</style>

<script>
function joinBooking(bookingId) {
    if (!confirm('Вы уверены, что хотите присоединиться к этому бронированию?')) {
        return;
    }

    const btn = document.querySelector(`[data-booking-id="${bookingId}"]`);
    const originalHtml = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Присоединяюсь...';
    btn.disabled = true;

    fetch(`/booking/join/${bookingId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert(data.message);
            btn.innerHTML = originalHtml;
            btn.disabled = false;
        }
    })
    .catch(error => {
        alert('Произошла ошибка при присоединении');
        btn.innerHTML = originalHtml;
        btn.disabled = false;
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
