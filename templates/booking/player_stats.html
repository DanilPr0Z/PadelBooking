{% extends 'base.html' %}
{% load static %}

{% block title %}–ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞{% endblock %}

{% block extra_css %}
<style>
    .stats-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }

    .stats-header {
        text-align: center;
        margin-bottom: 40px;
    }

    .stats-title {
        font-size: 36px;
        font-weight: 700;
        background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 10px;
    }

    .stats-subtitle {
        font-size: 16px;
        color: #6b7280;
    }

    /* –ö–∞—Ä—Ç–æ—á–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
    }

    .stat-card {
        background: white;
        padding: 25px;
        border-radius: 16px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.07);
        transition: transform 0.2s, box-shadow 0.2s;
        position: relative;
        overflow: hidden;
    }

    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 15px rgba(0,0,0,0.12);
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: linear-gradient(90deg, #3b82f6, #8b5cf6);
    }

    .stat-icon {
        font-size: 36px;
        margin-bottom: 10px;
    }

    .stat-value {
        font-size: 32px;
        font-weight: 700;
        color: #1a1a1a;
        margin-bottom: 5px;
    }

    .stat-label {
        font-size: 14px;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* –ì—Ä–∞—Ñ–∏–∫–∏ */
    .charts-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        gap: 30px;
        margin-bottom: 40px;
    }

    .chart-card {
        background: white;
        padding: 30px;
        border-radius: 16px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.07);
    }

    .chart-title {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 20px;
        color: #1a1a1a;
    }

    /* –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è */
    .achievements-section {
        background: white;
        padding: 30px;
        border-radius: 16px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.07);
        margin-bottom: 40px;
    }

    .achievements-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .achievement-card {
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
        transition: all 0.3s;
    }

    .achievement-card.unlocked {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3);
    }

    .achievement-card.unlocked.platinum {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .achievement-card.unlocked.diamond {
        background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }

    .achievement-icon {
        font-size: 48px;
        margin-bottom: 10px;
        filter: grayscale(100%);
    }

    .achievement-card.unlocked .achievement-icon {
        filter: grayscale(0%);
        animation: bounce 0.5s ease;
    }

    @keyframes bounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-10px); }
    }

    .achievement-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 5px;
        color: #1a1a1a;
    }

    .achievement-desc {
        font-size: 12px;
        color: #6b7280;
    }

    .achievement-progress {
        width: 100%;
        height: 6px;
        background: #e5e7eb;
        border-radius: 3px;
        margin-top: 10px;
        overflow: hidden;
    }

    .achievement-progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #3b82f6, #8b5cf6);
        transition: width 0.3s ease;
    }

    /* –õ—é–±–∏–º—ã–µ –ø–∞—Ä—Ç–Ω–µ—Ä—ã */
    .partners-section {
        background: white;
        padding: 30px;
        border-radius: 16px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.07);
    }

    .partner-item {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 15px;
        margin-bottom: 10px;
        background: #f9fafb;
        border-radius: 12px;
        transition: background 0.2s;
    }

    .partner-item:hover {
        background: #f3f4f6;
    }

    .partner-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: linear-gradient(135deg, #3b82f6, #8b5cf6);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 20px;
        font-weight: 600;
    }

    .partner-info {
        flex: 1;
    }

    .partner-name {
        font-size: 16px;
        font-weight: 600;
        color: #1a1a1a;
    }

    .partner-games {
        font-size: 14px;
        color: #6b7280;
    }

    /* –†–µ–π—Ç–∏–Ω–≥ –ø—Ä–æ–≥—Ä–µ—Å—Å */
    .rating-section {
        background: white;
        padding: 30px;
        border-radius: 16px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.07);
        margin-bottom: 40px;
    }

    .rating-current {
        text-align: center;
        padding: 30px;
        background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
        border-radius: 12px;
        color: white;
        margin-bottom: 20px;
    }

    .rating-level {
        font-size: 48px;
        font-weight: 700;
        margin-bottom: 10px;
    }

    .rating-numeric {
        font-size: 24px;
        opacity: 0.9;
    }

    @media (max-width: 768px) {
        .charts-section {
            grid-template-columns: 1fr;
        }

        .stat-value {
            font-size: 24px;
        }

        .stats-title {
            font-size: 28px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="stats-container">
    <!-- Header -->
    <div class="stats-header">
        <h1 class="stats-title">üìä –ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h1>
        <p class="stats-subtitle">–ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –≤–∞—à–µ–π –∏–≥—Ä–æ–≤–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</p>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">üéæ</div>
            <div class="stat-value">{{ stats.total_games }}</div>
            <div class="stat-label">–í—Å–µ–≥–æ –∏–≥—Ä</div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">‚è±Ô∏è</div>
            <div class="stat-value">{{ stats.total_hours }}</div>
            <div class="stat-label">–ß–∞—Å–æ–≤ –Ω–∞ –∫–æ—Ä—Ç–µ</div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">üí∞</div>
            <div class="stat-value">{{ stats.total_spent }}</div>
            <div class="stat-label">–ü–æ—Ç—Ä–∞—á–µ–Ω–æ (‚ÇΩ)</div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">üìÖ</div>
            <div class="stat-value">{{ stats.upcoming_games }}</div>
            <div class="stat-label">–ü—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö –∏–≥—Ä</div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">üî•</div>
            <div class="stat-value">{{ stats.games_per_week }}</div>
            <div class="stat-label">–ò–≥—Ä –≤ –Ω–µ–¥–µ–ª—é</div>
        </div>

        {% if stats.favorite_court %}
        <div class="stat-card">
            <div class="stat-icon">üèÜ</div>
            <div class="stat-value" style="font-size: 20px;">{{ stats.favorite_court.court__name }}</div>
            <div class="stat-label">–õ—é–±–∏–º—ã–π –∫–æ—Ä—Ç</div>
        </div>
        {% endif %}
    </div>

    <!-- –†–µ–π—Ç–∏–Ω–≥ -->
    {% if stats.current_rating %}
    <div class="rating-section">
        <h2 class="chart-title">–í–∞—à —Ä–µ–π—Ç–∏–Ω–≥</h2>
        <div class="rating-current">
            <div class="rating-level">{{ stats.current_rating.level }}</div>
            <div class="rating-numeric">{{ stats.current_rating.numeric }} / 7.00</div>
        </div>
        {% if stats.rating_progress %}
        <div style="height: 300px;">
            <canvas id="ratingChart"></canvas>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
    <div class="charts-section">
        <div class="chart-card">
            <h3 class="chart-title">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –º–µ—Å—è—Ü–∞–º</h3>
            <canvas id="monthlyChart"></canvas>
        </div>

        <div class="chart-card">
            <h3 class="chart-title">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏</h3>
            <canvas id="weekdayChart"></canvas>
        </div>
    </div>

    <!-- –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è -->
    {% if stats.achievements %}
    <div class="achievements-section">
        <h2 class="chart-title">üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h2>
        <div class="achievements-grid">
            {% for achievement in stats.achievements %}
            <div class="achievement-card {% if achievement.unlocked %}unlocked {{ achievement.type }}{% endif %}">
                <div class="achievement-icon">{{ achievement.title|slice:":2" }}</div>
                <div class="achievement-title">{{ achievement.title|slice:"2:" }}</div>
                <div class="achievement-desc">{{ achievement.description }}</div>
                {% if not achievement.unlocked %}
                <div class="achievement-progress">
                    <div class="achievement-progress-bar" style="width: {{ achievement.progress }}%"></div>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- –õ—é–±–∏–º—ã–µ –ø–∞—Ä—Ç–Ω–µ—Ä—ã -->
    {% if stats.favorite_partners %}
    <div class="partners-section">
        <h2 class="chart-title">üë• –õ—é–±–∏–º—ã–µ –ø–∞—Ä—Ç–Ω–µ—Ä—ã</h2>
        {% for partner in stats.favorite_partners %}
        <div class="partner-item">
            <div class="partner-avatar">
                {{ partner.full_name|slice:":1"|upper }}
            </div>
            <div class="partner-info">
                <div class="partner-name">{{ partner.full_name }}</div>
                <div class="partner-games">{{ partner.games_count }} –∏–≥—Ä –≤–º–µ—Å—Ç–µ</div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
// –ì—Ä–∞—Ñ–∏–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ –º–µ—Å—è—Ü–∞–º
const monthlyData = {{ stats.monthly_activity|safe }};
const monthlyLabels = monthlyData.map(item => {
    const date = new Date(item.month + '-01');
    return date.toLocaleDateString('ru-RU', { month: 'short', year: 'numeric' });
});
const monthlyValues = monthlyData.map(item => item.games);

new Chart(document.getElementById('monthlyChart'), {
    type: 'line',
    data: {
        labels: monthlyLabels,
        datasets: [{
            label: '–ò–≥—Ä',
            data: monthlyValues,
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            tension: 0.4,
            fill: true
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        }
    }
});

// –ì—Ä–∞—Ñ–∏–∫ –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏
const weekdayData = {{ stats.weekday_stats|safe }};
const weekdayLabels = weekdayData.map(item => item.day);
const weekdayValues = weekdayData.map(item => item.games);

new Chart(document.getElementById('weekdayChart'), {
    type: 'bar',
    data: {
        labels: weekdayLabels,
        datasets: [{
            label: '–ò–≥—Ä',
            data: weekdayValues,
            backgroundColor: [
                'rgba(239, 68, 68, 0.7)',
                'rgba(249, 115, 22, 0.7)',
                'rgba(234, 179, 8, 0.7)',
                'rgba(34, 197, 94, 0.7)',
                'rgba(59, 130, 246, 0.7)',
                'rgba(99, 102, 241, 0.7)',
                'rgba(168, 85, 247, 0.7)'
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        }
    }
});

// –ì—Ä–∞—Ñ–∏–∫ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞
{% if stats.rating_progress %}
const ratingData = {{ stats.rating_progress|safe }};
const ratingLabels = ratingData.map(item => {
    const date = new Date(item.date);
    return date.toLocaleDateString('ru-RU', { month: 'short', day: 'numeric' });
});
const ratingValues = ratingData.map(item => parseFloat(item.rating));

new Chart(document.getElementById('ratingChart'), {
    type: 'line',
    data: {
        labels: ratingLabels,
        datasets: [{
            label: '–†–µ–π—Ç–∏–Ω–≥',
            data: ratingValues,
            borderColor: '#8b5cf6',
            backgroundColor: 'rgba(139, 92, 246, 0.1)',
            tension: 0.4,
            fill: true,
            pointRadius: 5,
            pointHoverRadius: 7
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                min: 1,
                max: 7,
                ticks: {
                    stepSize: 0.5
                }
            }
        }
    }
});
{% endif %}
</script>
{% endblock %}
